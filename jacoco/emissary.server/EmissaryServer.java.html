<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmissaryServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.server</a> &gt; <span class="el_source">EmissaryServer.java</span></div><h1>EmissaryServer.java</h1><pre class="source lang-java linenums">package emissary.server;

import emissary.admin.Startup;
import emissary.client.EmissaryClient;
import emissary.client.EmissaryResponse;
import emissary.client.HTTPConnectionFactory;
import emissary.command.ServerCommand;
import emissary.config.ConfigUtil;
import emissary.config.Configurator;
import emissary.core.EmissaryException;
import emissary.core.EmissaryRuntimeException;
import emissary.core.IPausable;
import emissary.core.MetricsManager;
import emissary.core.MobileAgent;
import emissary.core.Namespace;
import emissary.core.NamespaceException;
import emissary.core.ResourceWatcher;
import emissary.core.sentinel.Sentinel;
import emissary.directory.DirectoryPlace;
import emissary.directory.EmissaryNode;
import emissary.place.IServiceProviderPlace;
import emissary.place.ServiceProviderRefreshablePlace;
import emissary.pool.AgentPool;
import emissary.pool.MoveSpool;
import emissary.roll.RollManager;
import emissary.server.mvc.ThreadDumpAction;
import emissary.server.mvc.ThreadDumpAction.ThreadDumpInfo;
import emissary.spi.SPILoader;

import ch.qos.logback.classic.ViewStatusMessagesServlet;
import com.google.common.annotations.VisibleForTesting;
import jakarta.annotation.Nullable;
import org.apache.hc.client5.http.classic.methods.HttpGet;
import org.eclipse.jetty.http.HttpVersion;
import org.eclipse.jetty.security.ConstraintMapping;
import org.eclipse.jetty.security.ConstraintSecurityHandler;
import org.eclipse.jetty.security.HashLoginService;
import org.eclipse.jetty.security.LoginService;
import org.eclipse.jetty.security.authentication.DigestAuthenticator;
import org.eclipse.jetty.server.Connector;
import org.eclipse.jetty.server.HttpConfiguration;
import org.eclipse.jetty.server.HttpConnectionFactory;
import org.eclipse.jetty.server.SecureRequestCustomizer;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.ServerConnector;
import org.eclipse.jetty.server.SslConnectionFactory;
import org.eclipse.jetty.server.handler.ContextHandler;
import org.eclipse.jetty.server.handler.HandlerList;
import org.eclipse.jetty.servlet.DefaultServlet;
import org.eclipse.jetty.servlet.ServletContextHandler;
import org.eclipse.jetty.servlet.ServletHolder;
import org.eclipse.jetty.util.security.Constraint;
import org.eclipse.jetty.util.ssl.SslContextFactory;
import org.eclipse.jetty.util.thread.QueuedThreadPool;
import org.glassfish.jersey.jackson.JacksonFeature;
import org.glassfish.jersey.media.multipart.MultiPartFeature;
import org.glassfish.jersey.server.ResourceConfig;
import org.glassfish.jersey.server.filter.CsrfProtectionFilter;
import org.glassfish.jersey.server.mvc.mustache.MustacheMvcFeature;
import org.glassfish.jersey.servlet.ServletContainer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.CertificateException;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import javax.naming.directory.AttributeInUseException;

public class EmissaryServer {

    /* Default namespace name */
    public static final String DEFAULT_NAMESPACE_NAME = &quot;EmissaryServer&quot;;

    // Our logger
<span class="fc" id="L86">    private static final Logger LOG = LoggerFactory.getLogger(EmissaryServer.class);</span>

    // Our namespace
<span class="pc" id="L89">    @Nullable</span>
    private String nameSpaceName = null;

    private Server server;

    private final ServerCommand cmd;

    private final EmissaryNode emissaryNode;

    @SuppressWarnings(&quot;NonFinalStaticField&quot;)
    private static EmissaryServer emissaryServer;

<span class="fc" id="L101">    private EmissaryServer(ServerCommand cmd) {</span>
<span class="fc" id="L102">        this.cmd = cmd;</span>
<span class="fc" id="L103">        this.emissaryNode = new EmissaryNode(cmd.getMode());</span>
<span class="fc" id="L104">    }</span>

    // there should be a better way to set a custom peer.cfg than this
<span class="nc" id="L107">    private EmissaryServer(ServerCommand cmd, EmissaryNode node) {</span>
<span class="nc" id="L108">        this.cmd = cmd;</span>
<span class="nc" id="L109">        this.emissaryNode = node;</span>
<span class="nc" id="L110">    }</span>

    public static EmissaryServer init(ServerCommand cmd) {
<span class="fc" id="L113">        emissaryServer = new EmissaryServer(cmd);</span>
<span class="fc" id="L114">        return emissaryServer;</span>
    }

    // there should be a better way to set a custom peer.cfg than this
    public static EmissaryServer init(ServerCommand cmd, EmissaryNode node) {
<span class="nc" id="L119">        emissaryServer = new EmissaryServer(cmd, node);</span>
<span class="nc" id="L120">        return emissaryServer;</span>
    }

    public static boolean isInitialized() {
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        return emissaryServer != null;</span>
    }

    public static EmissaryServer getInstance() {
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (emissaryServer == null) {</span>
<span class="nc" id="L129">            throw new AssertionError(&quot;EmissaryServer has not yet been instantiated!&quot;);</span>
        }
<span class="fc" id="L131">        return emissaryServer;</span>
    }

    public EmissaryNode getNode() {
<span class="fc" id="L135">        return this.emissaryNode;</span>
    }

    public ServerCommand getServerCommand() {
<span class="fc" id="L139">        return cmd;</span>
    }

    /**
     * Creates and starts a server that is bound into the local Namespace using DEFAULT_NAMESPACE_NAME and returned
     *
     *
     */
    public Server startServer() {
        // do what StartJetty and then JettyServer did to start
        try {
            // Resource.setDefaultUseCaches(false);

            // needs to be loaded first into the server as it setups up Emissary stuff
<span class="fc" id="L153">            ContextHandler emissaryHandler = buildEmissaryHandler();</span>
            // TODO: rework this, no need for it be set with a context path but if this
            // is left out, it matches / and nothing works correctly
<span class="fc" id="L156">            emissaryHandler.setContextPath(&quot;/idontreallyservecontentnowdoi&quot;);</span>
<span class="fc" id="L157">            ContextHandler lbConfigHandler = buildLogbackConfigHandler();</span>
<span class="fc" id="L158">            lbConfigHandler.setContextPath(&quot;/lbConfig&quot;);</span>
<span class="fc" id="L159">            ContextHandler apiHandler = buildApiHandler();</span>
<span class="fc" id="L160">            apiHandler.setContextPath(&quot;/api&quot;);</span>
<span class="fc" id="L161">            ContextHandler mvcHandler = buildMvcHandler();</span>
<span class="fc" id="L162">            mvcHandler.setContextPath(&quot;/emissary&quot;);</span>
            // needs to be loaded last into the server so other contexts can match or fall through
<span class="fc" id="L164">            ContextHandler staticHandler = buildStaticHandler();</span>
<span class="fc" id="L165">            staticHandler.setContextPath(&quot;/&quot;);</span>

<span class="fc" id="L167">            LoginService loginService = buildLoginService();</span>
<span class="fc" id="L168">            ConstraintSecurityHandler security = buildSecurityHandler();</span>
<span class="fc" id="L169">            security.setLoginService(loginService);</span>

            // secure some of the contexts
<span class="fc" id="L172">            final HandlerList securedHandlers = new HandlerList();</span>
<span class="fc" id="L173">            securedHandlers.addHandler(lbConfigHandler);</span>
<span class="fc" id="L174">            securedHandlers.addHandler(apiHandler);</span>
<span class="fc" id="L175">            securedHandlers.addHandler(mvcHandler);</span>
<span class="fc" id="L176">            securedHandlers.addHandler(staticHandler);</span>
<span class="fc" id="L177">            security.setHandler(securedHandlers);</span>

<span class="fc" id="L179">            final HandlerList handlers = new HandlerList();</span>
<span class="fc" id="L180">            handlers.addHandler(emissaryHandler); // not secured, no endpoints and must be loaded first</span>
<span class="fc" id="L181">            handlers.addHandler(security);</span>

<span class="fc" id="L183">            Server configuredServer = configureServer();</span>
<span class="fc" id="L184">            configuredServer.setHandler(handlers);</span>
<span class="fc" id="L185">            configuredServer.addBean(loginService);</span>
<span class="fc" id="L186">            configuredServer.setStopAtShutdown(true);</span>
<span class="fc" id="L187">            configuredServer.setStopTimeout(10000L);</span>
<span class="pc bpc" id="L188" title="3 of 4 branches missed.">            if (this.cmd.shouldDumpJettyBeans() &amp;&amp; LOG.isInfoEnabled()) {</span>
<span class="nc" id="L189">                LOG.info(configuredServer.dump());</span>
            }
<span class="fc" id="L191">            this.server = configuredServer;</span>
<span class="fc" id="L192">            bindServer(); // emissary specific</span>

<span class="fc" id="L194">            configuredServer.start();</span>
            // server.join(); // don't join so we can shutdown

<span class="fc" id="L197">            String serverLocation = cmd.getScheme() + &quot;://&quot; + cmd.getHost() + &quot;:&quot; + cmd.getPort();</span>

            // write out env.sh file here
<span class="fc" id="L200">            Path envsh = Paths.get(ConfigUtil.getProjectBase() + File.separator + &quot;env.sh&quot;);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">            if (Files.exists(envsh)) {</span>
<span class="fc" id="L202">                LOG.debug(&quot;Removing old {}&quot;, envsh.toAbsolutePath());</span>
<span class="fc" id="L203">                Files.delete(envsh);</span>
            }
<span class="fc" id="L205">            String envUri = serverLocation + &quot;/api/env.sh&quot;;</span>
<span class="fc" id="L206">            EmissaryResponse er = new EmissaryClient().send(new HttpGet(envUri));</span>
<span class="fc" id="L207">            String envString = er.getContentString();</span>
<span class="fc" id="L208">            Files.createFile(envsh);</span>
<span class="fc" id="L209">            Files.write(envsh, envString.getBytes());</span>
<span class="fc" id="L210">            LOG.info(&quot;Wrote {}&quot;, envsh.toAbsolutePath());</span>
<span class="fc" id="L211">            LOG.debug(&quot; with \n{}&quot;, envString);</span>

<span class="pc bpc" id="L213" title="1 of 2 branches missed.">            if (cmd.isPause()) {</span>
<span class="nc" id="L214">                pause(true);</span>
            } else {
<span class="fc" id="L216">                unpause(true);</span>
            }

<span class="fc" id="L219">            LOG.info(&quot;Started EmissaryServer at {}&quot;, serverLocation);</span>

            // check if invisible place start-ups occurred on strict server start-up, and shut down server if so.
<span class="pc bpc" id="L222" title="3 of 4 branches missed.">            if (Startup.isInvisPlacesStartedInStrictMode() &amp;&amp; this.server.isStarted()) {</span>
<span class="nc" id="L223">                EmissaryServer.stopServer(true);</span>
<span class="nc" id="L224">                LOG.info(&quot;Server shut down due to invisible place startups on strict-mode: {}&quot;, Startup.getInvisPlaces());</span>
            }

<span class="fc" id="L227">            return configuredServer;</span>
<span class="nc" id="L228">        } catch (Throwable t) {</span>
<span class="nc" id="L229">            String errorMsg = &quot;Emissary server didn't start&quot;;</span>
<span class="nc" id="L230">            throw new EmissaryRuntimeException(errorMsg, t);</span>
        }
    }

    /**
     * Check is server is running
     *
     * @return true if running
     */
    public boolean isServerRunning() {
<span class="pc bpc" id="L240" title="3 of 4 branches missed.">        return (this.server != null) &amp;&amp; this.server.isStarted();</span>
    }


    /**
     * Pause the server
     *
     * @throws NamespaceException if there is an issue
     */
    public static void pause() throws NamespaceException {
<span class="nc" id="L250">        pause(false);</span>
<span class="nc" id="L251">    }</span>

    /**
     * Pause the server
     *
     * @param silent true to silence {@link NamespaceException}, false otherwise
     * @throws NamespaceException if there is an issue
     */
    public static void pause(boolean silent) throws NamespaceException {
<span class="nc" id="L260">        LOG.debug(&quot;Pausing Emissary Server&quot;);</span>
<span class="nc" id="L261">        Namespace.lookup(IPausable.class, silent).forEach(IPausable::pause);</span>
<span class="nc" id="L262">    }</span>

    /**
     * Unpause the server
     *
     * @throws NamespaceException if there is an issue
     */
    public static void unpause() throws NamespaceException {
<span class="nc" id="L270">        unpause(false);</span>
<span class="nc" id="L271">    }</span>

    /**
     * Unpause the server
     *
     * @param silent true to silence {@link NamespaceException}, false otherwise
     * @throws NamespaceException if there is an issue
     */
    public static void unpause(boolean silent) throws NamespaceException {
<span class="fc" id="L280">        LOG.debug(&quot;Unpausing Emissary Server&quot;);</span>
<span class="fc" id="L281">        Namespace.lookup(IPausable.class, silent).forEach(IPausable::unpause);</span>
<span class="fc" id="L282">    }</span>

    /**
     * Invalidate places that are reconfigurable/refreshable
     *
     * @throws NamespaceException if there is an issue
     */
    public static void invalidate() throws NamespaceException {
<span class="nc" id="L290">        LOG.info(&quot;Invalidating places that need to be reconfigured&quot;);</span>
<span class="nc" id="L291">        Namespace.lookup(ServiceProviderRefreshablePlace.class, true).forEach(ServiceProviderRefreshablePlace::invalidate);</span>
<span class="nc" id="L292">    }</span>

    /**
     * Refresh reloadable places
     */
    public static void refresh() {
        try {
<span class="nc" id="L299">            pause();</span>
<span class="nc" id="L300">            waitForAgentsToDrain();</span>
<span class="nc" id="L301">            Namespace.lookup(ServiceProviderRefreshablePlace.class)</span>
<span class="nc" id="L302">                    .forEach(p -&gt; {</span>
<span class="nc" id="L303">                        p.invalidate();</span>
<span class="nc" id="L304">                        p.refresh(true);</span>
<span class="nc" id="L305">                    });</span>
<span class="nc" id="L306">            unpause();</span>
<span class="nc" id="L307">        } catch (Throwable e) {</span>
<span class="nc" id="L308">            LOG.error(&quot;There was an error trying to refresh services, shutting down!!&quot;, e);</span>
<span class="nc" id="L309">            stopServer();</span>
<span class="nc" id="L310">        }</span>
<span class="nc" id="L311">    }</span>

    private static void waitForAgentsToDrain() throws NamespaceException, TimeoutException {
        long agentCount;
        try {
<span class="nc" id="L316">            long maxWait = getInstance().getNode().getNodeRefreshTimeout();</span>
<span class="nc" id="L317">            long timeout = System.currentTimeMillis() + maxWait;</span>
<span class="nc" id="L318">            final Set&lt;MobileAgent&gt; agents = Namespace.lookup(MobileAgent.class, true);</span>
<span class="nc" id="L319">            LOG.info(&quot;Waiting for server to drain, waiting max of {} minutes...&quot;, TimeUnit.MILLISECONDS.toMinutes(maxWait));</span>
            do {
<span class="nc" id="L321">                TimeUnit.SECONDS.sleep(5);</span>
<span class="nc" id="L322">                agentCount = agents.stream().filter(MobileAgent::isInUse).count();</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">            } while (agentCount &gt; 0 &amp;&amp; System.currentTimeMillis() &lt; timeout);</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (agentCount &gt; 0) {</span>
<span class="nc" id="L326">                throw new TimeoutException(&quot;Server did not drain in the allotted amount of time&quot;);</span>
            }
<span class="nc" id="L328">        } catch (InterruptedException e) {</span>
<span class="nc" id="L329">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L330">        }</span>
<span class="nc" id="L331">    }</span>

    /**
     * Stop the server
     */
    public static void stopServer() {
<span class="nc" id="L337">        stopServer(false);</span>
<span class="nc" id="L338">    }</span>

    /**
     * Stop the server running under the default name
     *
     * @param force force shutdown
     * @param quiet be quiet about failures if true
     */
    @Deprecated
    public static void stopServer(final boolean force, final boolean quiet) {
<span class="nc" id="L348">        stopServer(getDefaultNamespaceName(), force, quiet);</span>
<span class="nc" id="L349">    }</span>

    /**
     * Stop the server if it is running and remove it from the namespace
     *
     * @param name the namespace name of the server
     * @param quiet be quiet about failures if true
     */
    @Deprecated
    public static void stopServer(final String name, final boolean quiet) {
<span class="nc" id="L359">        stopServer(name, false, quiet);</span>
<span class="nc" id="L360">    }</span>

    /**
     * Stop the server if it is running and remove it from the namespace
     *
     * @param name the namespace name of the server
     * @param force force shutdown
     * @param quiet be quiet about failures if true
     */
    @Deprecated
    public static void stopServer(final String name, final boolean force, final boolean quiet) {
<span class="nc" id="L371">        stopServer(force);</span>
<span class="nc" id="L372">    }</span>

    /**
     * Stop the server with an optional force flag
     *
     * @param force force shutdown
     */
    public static void stopServer(final boolean force) {
        // TODO pull these out to methods and test them

<span class="nc" id="L382">        LOG.info(&quot;Beginning shutdown of EmissaryServer&quot;);</span>
<span class="nc" id="L383">        logThreadDump(&quot;Thread dump before anything&quot;);</span>

        try {
<span class="nc" id="L386">            pause();</span>
<span class="nc" id="L387">            LOG.info(&quot;Done pausing server&quot;);</span>
<span class="nc" id="L388">        } catch (Exception ex) {</span>
<span class="nc" id="L389">            LOG.error(&quot;Error pausing server&quot;, ex);</span>
<span class="nc" id="L390">        }</span>

        try {
<span class="nc" id="L393">            Sentinel sentinel = Sentinel.lookup();</span>
<span class="nc" id="L394">            sentinel.quit();</span>
<span class="nc" id="L395">        } catch (Exception ex) {</span>
<span class="nc" id="L396">            LOG.warn(&quot;No sentinel available&quot;);</span>
<span class="nc" id="L397">        }</span>

        try {
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (force) {</span>
<span class="nc" id="L401">                AgentPool.lookup().kill();</span>
            } else {
<span class="nc" id="L403">                AgentPool.lookup().close();</span>
            }
<span class="nc" id="L405">        } catch (Exception e) {</span>
<span class="nc" id="L406">            LOG.warn(&quot;Problem stopping AgentPool&quot;, e);</span>
<span class="nc" id="L407">        }</span>

<span class="nc" id="L409">        logThreadDump(&quot;Thread dump after closing agent pool&quot;);</span>

        try {
<span class="nc" id="L412">            DirectoryPlace.lookup().shutDown();</span>
<span class="nc" id="L413">        } catch (Exception e) {</span>
<span class="nc" id="L414">            LOG.warn(&quot;Problem shutting down DirectoryPlace&quot;, e);</span>
<span class="nc" id="L415">        }</span>

        try {
<span class="nc" id="L418">            MoveSpool.lookup().quit();</span>
<span class="nc" id="L419">        } catch (Exception e) {</span>
<span class="nc" id="L420">            LOG.warn(&quot;Problem stopping MoveSpool&quot;, e);</span>
<span class="nc" id="L421">        }</span>

        // Stop the places
<span class="nc bnc" id="L424" title="All 2 branches missed.">        for (String key : Namespace.keySet()) {</span>
            try {
<span class="nc" id="L426">                Object obj = Namespace.lookup(key);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                if (obj instanceof IServiceProviderPlace) {</span>
<span class="nc" id="L428">                    LOG.info(&quot;Stopping {} &quot;, obj);</span>
<span class="nc" id="L429">                    ((IServiceProviderPlace) obj).shutDown();</span>
                    // make sure key is removed from namespace
<span class="nc" id="L431">                    Namespace.unbind(key);</span>
<span class="nc" id="L432">                    LOG.info(&quot;Done stopping place: {}&quot;, key);</span>
                }
<span class="nc" id="L434">            } catch (Exception ex) {</span>
<span class="nc" id="L435">                LOG.error(&quot;Error shutting down &quot; + key, ex);</span>
<span class="nc" id="L436">            }</span>
<span class="nc" id="L437">        }</span>
<span class="nc" id="L438">        LOG.info(&quot;Done stopping all places&quot;);</span>

<span class="nc" id="L440">        RollManager.shutdown();</span>

        // Print the stats
        try {
<span class="nc" id="L444">            ResourceWatcher rw = ResourceWatcher.lookup();</span>
<span class="nc" id="L445">            rw.logStats(LOG);</span>
<span class="nc" id="L446">            rw.quit();</span>
<span class="nc" id="L447">        } catch (Exception ex) {</span>
<span class="nc" id="L448">            LOG.warn(&quot;No resource statistics available&quot;);</span>
<span class="nc" id="L449">        }</span>

        try {
<span class="nc" id="L452">            MetricsManager.lookup().shutdown();</span>
<span class="nc" id="L453">        } catch (Exception ex) {</span>
<span class="nc" id="L454">            LOG.warn(&quot;No metrics manager available&quot;);</span>
<span class="nc" id="L455">        }</span>

<span class="nc" id="L457">        SPILoader.unload();</span>

<span class="nc" id="L459">        LOG.info(&quot;Done stopping all services&quot;);</span>

        // thread dump now
<span class="nc" id="L462">        logThreadDump(&quot;Thread dump before stopping jetty server&quot;);</span>

        try {
<span class="nc" id="L465">            EmissaryServer.getInstance().getServer().stop();</span>
<span class="nc" id="L466">        } catch (InterruptedException e) {</span>
<span class="nc" id="L467">            LOG.warn(&quot;Interrupted! Expected?&quot;);</span>
<span class="nc" id="L468">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L469">        } catch (Exception e) {</span>
<span class="nc" id="L470">            LOG.warn(&quot;Unable to stop EmissaryServer&quot;, e);</span>
<span class="nc" id="L471">        }</span>

<span class="nc" id="L473">        LOG.debug(&quot;Unbinding name: {}&quot;, getDefaultNamespaceName());</span>
<span class="nc" id="L474">        Namespace.unbind(getDefaultNamespaceName());</span>
<span class="nc" id="L475">        Namespace.clear();</span>
<span class="nc" id="L476">        LOG.info(&quot;EmissaryServer completely stopped&quot;);</span>
<span class="nc" id="L477">    }</span>

    /**
     * Forcibly stop the server running under the default name
     */
    public static void stopServerForce() {
<span class="nc" id="L483">        stopServer(true);</span>
<span class="nc" id="L484">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private static void logThreadDump(String initialLog) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L489">            ThreadDumpAction tda = new ThreadDumpAction();</span>
<span class="nc" id="L490">            Map&lt;String, Object&gt; dumps = tda.getThreaddumps();</span>
<span class="nc" id="L491">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L492">            sb.append(&quot;\n&quot; + initialLog);</span>
<span class="nc" id="L493">            sb.append(&quot;\nThread DUMP&quot;);</span>
<span class="nc" id="L494">            sb.append(&quot;\nEmissary Version: &quot; + dumps.get(&quot;emissary.version&quot;));</span>
<span class="nc" id="L495">            sb.append(&quot;\nJVM Version: &quot; + dumps.get(&quot;java.version&quot;));</span>
<span class="nc" id="L496">            sb.append(&quot;\nJVM Name: &quot; + dumps.get(&quot;java.name&quot;));</span>
<span class="nc" id="L497">            Map&lt;String, Object&gt; threadcount = (Map&lt;String, Object&gt;) dumps.get(&quot;threadcount&quot;);</span>
<span class="nc" id="L498">            sb.append(&quot;\nThread count: current=&quot; + threadcount.get(&quot;current&quot;) + &quot; max=&quot; + threadcount.get(&quot;max&quot;) + &quot; daemon=&quot;</span>
<span class="nc" id="L499">                    + threadcount.get(&quot;daemon&quot;));</span>
<span class="nc" id="L500">            sb.append(&quot;\nDeadlocked Threads:&quot;);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            for (ThreadDumpInfo tdi : (Set&lt;ThreadDumpInfo&gt;) dumps.get(&quot;deadlocks&quot;)) {</span>
<span class="nc" id="L502">                sb.append(&quot;\n&quot; + tdi.stack);</span>
<span class="nc" id="L503">            }</span>
<span class="nc" id="L504">            sb.append(&quot;\nThread dump:&quot;);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            for (ThreadDumpInfo tdi : (Set&lt;ThreadDumpInfo&gt;) dumps.get(&quot;threads&quot;)) {</span>
<span class="nc" id="L506">                sb.append(&quot;\n&quot; + tdi.stack);</span>
<span class="nc" id="L507">            }</span>
<span class="nc" id="L508">            LOG.trace(sb.toString());</span>
        }
<span class="nc" id="L510">    }</span>

    /**
     * Determine if the emissary node is idle
     */
    public boolean isIdle() {
        try {
<span class="nc" id="L517">            AgentPool pool = AgentPool.lookup();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">            return pool.getNumActive() == 0;</span>
<span class="nc" id="L519">        } catch (NamespaceException ignored) {</span>
            // empty catch block
        }
<span class="nc" id="L522">        return true;</span>
    }

    /**
     * Non-static way to stop a server
     */
    public void stop() {
<span class="nc" id="L529">        stopServer(false);</span>
<span class="nc" id="L530">    }</span>

    /**
     * Get the reference to the server
     */
    public Server getServer() {
<span class="nc" id="L536">        return this.server;</span>
    }

    @Deprecated
    public synchronized String getNamespaceName() {
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (this.nameSpaceName == null) {</span>
<span class="nc" id="L542">            this.nameSpaceName = getDefaultNamespaceName();</span>
        }
<span class="nc" id="L544">        return this.nameSpaceName;</span>
    }

    @Deprecated
    public static String getDefaultNamespaceName() {
<span class="fc" id="L549">        return DEFAULT_NAMESPACE_NAME;</span>
    }

    /**
     * Check if server is running
     *
     * @return true if it is in the namespace and is started
     * @deprecated use {@link #isServerRunning()}
     */
    @Deprecated
    public static boolean isStarted() {
<span class="nc" id="L560">        return isStarted(getDefaultNamespaceName());</span>
    }

    /**
     * Check if server is running
     *
     * @param name the namespace name to use as a key
     * @return true if it is in the namespace and is started
     */
    @Deprecated
    public static boolean isStarted(final String name) {
<span class="nc" id="L571">        boolean started = false;</span>
        try {
<span class="nc" id="L573">            final Server s = lookup(name).getServer();</span>
<span class="nc bnc" id="L574" title="All 4 branches missed.">            if (s != null &amp;&amp; s.isStarted()) {</span>
<span class="nc" id="L575">                started = true;</span>
            } else {
<span class="nc" id="L577">                LOG.debug(&quot;Server found but not started, name={}&quot;, name);</span>
            }
<span class="nc" id="L579">        } catch (NamespaceException ex) {</span>
<span class="nc" id="L580">            LOG.debug(&quot;No server found using name={}&quot;, name);</span>
<span class="nc" id="L581">        }</span>
<span class="nc" id="L582">        return started;</span>
    }

    @Deprecated
    public static boolean exists() {
        try {
<span class="nc" id="L588">            EmissaryServer.lookup();</span>
<span class="nc" id="L589">            return true;</span>
<span class="nc" id="L590">        } catch (NamespaceException ignored) {</span>
            // expected
        }
<span class="nc" id="L593">        return false;</span>
    }

    @Deprecated
    public static EmissaryServer lookup() throws NamespaceException {
<span class="nc" id="L598">        return lookup(getDefaultNamespaceName());</span>
    }

    /**
     * Retrieve instance from namespace using default name
     */
    @Deprecated
    public static EmissaryServer lookup(final String name) throws NamespaceException {
<span class="nc" id="L606">        return (EmissaryServer) Namespace.lookup(name);</span>
    }

    private static ConstraintSecurityHandler buildSecurityHandler() {
<span class="fc" id="L610">        ConstraintSecurityHandler handler = new ConstraintSecurityHandler();</span>

<span class="fc" id="L612">        Constraint authConstraint = new Constraint();</span>
<span class="fc" id="L613">        authConstraint.setName(&quot;auth&quot;);</span>
<span class="fc" id="L614">        authConstraint.setAuthenticate(true);</span>
<span class="fc" id="L615">        authConstraint.setRoles(new String[] {&quot;everyone&quot;, &quot;emissary&quot;, &quot;admin&quot;, &quot;support&quot;, &quot;manager&quot;});</span>

<span class="fc" id="L617">        Constraint noAuthConstraint = new Constraint();</span>
<span class="fc" id="L618">        noAuthConstraint.setName(&quot;no_auth&quot;);</span>
<span class="fc" id="L619">        noAuthConstraint.setAuthenticate(false);</span>

<span class="fc" id="L621">        ConstraintMapping mapping = new ConstraintMapping();</span>
<span class="fc" id="L622">        mapping.setPathSpec(&quot;/*&quot;);</span>
<span class="fc" id="L623">        mapping.setConstraint(authConstraint);</span>

<span class="fc" id="L625">        ConstraintMapping health = new ConstraintMapping();</span>
<span class="fc" id="L626">        health.setPathSpec(&quot;/api/health&quot;);</span>
<span class="fc" id="L627">        health.setConstraint(noAuthConstraint);</span>

<span class="fc" id="L629">        handler.setConstraintMappings(new ConstraintMapping[] {mapping, health});</span>
<span class="fc" id="L630">        handler.setAuthenticator(new DigestAuthenticator());</span>
<span class="fc" id="L631">        return handler;</span>
    }

    private static LoginService buildLoginService() {
<span class="fc" id="L635">        String jettyUsersFile = ConfigUtil.getConfigFile(&quot;jetty-users.properties&quot;);</span>
<span class="fc" id="L636">        System.setProperty(&quot;emissary.jetty.users.file&quot;, jettyUsersFile); // for EmissaryClient</span>
<span class="fc" id="L637">        return new HashLoginService(&quot;EmissaryRealm&quot;, jettyUsersFile);</span>
    }

    private void bindServer() throws AttributeInUseException {
<span class="pc bpc" id="L641" title="1 of 2 branches missed.">        if (Namespace.exists(getDefaultNamespaceName())) {</span>
<span class="nc" id="L642">            LOG.error(&quot;EmissaryServer already bound to namespace. This should NEVER happen.&quot;);</span>
<span class="nc" id="L643">            throw new AttributeInUseException(&quot;EmissaryServer was already bound to the namespace using serverName: &quot; + DEFAULT_NAMESPACE_NAME);</span>
        }

<span class="fc" id="L646">        LOG.debug(&quot;Binding {} &quot;, DEFAULT_NAMESPACE_NAME);</span>
<span class="fc" id="L647">        Namespace.bind(getDefaultNamespaceName(), this);</span>
<span class="fc" id="L648">    }</span>

    private ContextHandler buildStaticHandler() {
        // Add pathspec for static assets
<span class="fc" id="L652">        ServletHolder homeHolder = new ServletHolder(&quot;static-holder&quot;, DefaultServlet.class);</span>
        // If no filesytem path was passed in, load assets from the classpath
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">        if (null == cmd.getStaticDir()) {</span>
<span class="fc" id="L655">            LOG.debug(&quot;Loading static resources from the classpath&quot;);</span>
<span class="fc" id="L656">            homeHolder.setInitParameter(&quot;resourceBase&quot;, this.getClass().getClassLoader().getResource(&quot;public&quot;).toExternalForm());</span>
        } else {
            // use --staticDir ${project_loc}/src/main/resources/public as command args
<span class="nc" id="L659">            LOG.debug(&quot;Loading static resources from staticPath: {}&quot;, cmd.getStaticDir());</span>
<span class="nc" id="L660">            homeHolder.setInitParameter(&quot;resourceBase&quot;, cmd.getStaticDir().toAbsolutePath().toString());</span>
        }
<span class="fc" id="L662">        homeHolder.setInitParameter(&quot;dirAllowed&quot;, &quot;true&quot;);</span>
<span class="fc" id="L663">        homeHolder.setInitParameter(&quot;pathInfoOnly&quot;, &quot;true&quot;);</span>
        // homeHolder.setInitOrder(0);

<span class="fc" id="L666">        ServletContextHandler homeContextHandler = new ServletContextHandler(ServletContextHandler.SESSIONS);</span>
<span class="fc" id="L667">        homeContextHandler.addServlet(homeHolder, &quot;/*&quot;);</span>

<span class="fc" id="L669">        return homeContextHandler;</span>
    }

    private ContextHandler buildApiHandler() {

<span class="fc" id="L674">        final ResourceConfig application = new ResourceConfig();</span>
<span class="fc" id="L675">        application.setApplicationName(&quot;api&quot;);</span>
<span class="fc" id="L676">        application.register(MultiPartFeature.class);</span>
        // setup rest endpoint
<span class="fc" id="L678">        application.packages(&quot;emissary.server.api&quot;).register(JacksonFeature.class);</span>
<span class="fc" id="L679">        csrfFilter(application);</span>

<span class="fc" id="L681">        ServletHolder apiHolder = new ServletHolder(new ServletContainer(application));</span>

<span class="fc" id="L683">        ServletContextHandler apiHolderContext = new ServletContextHandler(ServletContextHandler.SESSIONS);</span>
<span class="fc" id="L684">        apiHolderContext.addServlet(apiHolder, &quot;/*&quot;);</span>

<span class="fc" id="L686">        return apiHolderContext;</span>
    }

    private ContextHandler buildMvcHandler() {

<span class="fc" id="L691">        final ResourceConfig application = new ResourceConfig();</span>
<span class="fc" id="L692">        application.setApplicationName(&quot;mvc&quot;);</span>
<span class="fc" id="L693">        application.register(MultiPartFeature.class);</span>
        // setup mustache templates
<span class="fc" id="L695">        application.property(MustacheMvcFeature.TEMPLATE_BASE_PATH, &quot;/templates&quot;);</span>
<span class="fc" id="L696">        application.register(MustacheMvcFeature.class).packages(&quot;emissary.server.mvc&quot;);</span>
<span class="fc" id="L697">        csrfFilter(application);</span>

<span class="fc" id="L699">        ServletHolder mvcHolder = new ServletHolder(new ServletContainer(application));</span>
        // mvcHolder.setInitOrder(1);

<span class="fc" id="L702">        ServletContextHandler mvcHolderContext = new ServletContextHandler(ServletContextHandler.SESSIONS);</span>
<span class="fc" id="L703">        mvcHolderContext.addServlet(mvcHolder, &quot;/*&quot;);</span>

<span class="fc" id="L705">        return mvcHolderContext;</span>
    }

    protected void csrfFilter(ResourceConfig application) {
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">        if (this.cmd.isCsrf()) {</span>
<span class="fc" id="L710">            LOG.debug(&quot;Enabling csrf protection filter for {}&quot;, application.getApplicationName());</span>
<span class="fc" id="L711">            application.register(CsrfProtectionFilter.class);</span>
        } else {
<span class="nc" id="L713">            LOG.debug(&quot;Disabling csrf protection filter for {}&quot;, application.getApplicationName());</span>
        }
<span class="fc" id="L715">    }</span>

    private ContextHandler buildEmissaryHandler() throws EmissaryException {
        // must set these set or you are not an EmissaryNode
<span class="fc" id="L719">        String configDir = System.getProperty(ConfigUtil.CONFIG_DIR_PROPERTY, null);</span>
<span class="pc bpc" id="L720" title="2 of 4 branches missed.">        if (configDir == null || !Files.exists(Paths.get(configDir))) {</span>
<span class="nc" id="L721">            throw new EmissaryException(&quot;Config dir error. &quot; + ConfigUtil.CONFIG_DIR_PROPERTY + &quot; is &quot; + configDir);</span>
        }
        // set number of agents if it has been set
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">        if (cmd.getAgents() != 0) {</span>
<span class="fc" id="L725">            System.setProperty(&quot;agent.poolsize&quot;, Integer.toString(cmd.getAgents()));</span>
        }

<span class="fc" id="L728">        ServletContextHandler emissaryHolderContext = new ServletContextHandler(ServletContextHandler.SESSIONS);</span>
<span class="fc" id="L729">        emissaryHolderContext.addEventListener(new InitializeContext(emissaryNode));</span>

<span class="fc" id="L731">        return emissaryHolderContext;</span>
    }

    private static ContextHandler buildLogbackConfigHandler() {
<span class="fc" id="L735">        ServletHolder lbHolder = new ServletHolder(&quot;logback-config-holder&quot;, ViewStatusMessagesServlet.class);</span>
<span class="fc" id="L736">        ServletContextHandler lbHolderContext = new ServletContextHandler(ServletContextHandler.SESSIONS);</span>
<span class="fc" id="L737">        lbHolderContext.addServlet(lbHolder, &quot;/*&quot;);</span>

<span class="fc" id="L739">        return lbHolderContext;</span>
    }

    @VisibleForTesting
    protected Server configureServer() throws IOException {
<span class="fc" id="L744">        int maxThreads = 250;</span>
<span class="fc" id="L745">        int minThreads = 10;</span>
<span class="fc" id="L746">        int lowThreads = 50;</span>
<span class="fc" id="L747">        int threadsPriority = 9;</span>
<span class="fc" id="L748">        int idleTimeout = (int) TimeUnit.MINUTES.toMillis(15);</span>

<span class="fc" id="L750">        QueuedThreadPool threadPool = new QueuedThreadPool(maxThreads, minThreads, idleTimeout);</span>
<span class="fc" id="L751">        threadPool.setLowThreadsThreshold(lowThreads);</span>
<span class="fc" id="L752">        threadPool.setThreadsPriority(threadsPriority);</span>

<span class="fc" id="L754">        Server configuredServer = new Server(threadPool);</span>
<span class="fc" id="L755">        configuredServer.setConnectors(new Connector[] {</span>
<span class="fc" id="L756">                createServerConnector(configuredServer)</span>
        });
<span class="fc" id="L758">        return configuredServer;</span>
    }

    /**
     * Create a server connector, insecure (http) or secure (https) depending on {@link ServerCommand#isSslEnabled()}
     *
     * @param server the Jetty HTTP Servlet Server
     * @return server connector that is the primary connector for the Jetty server over TCP/IP
     * @throws IOException if there is an error
     */
    private ServerConnector createServerConnector(Server server) throws IOException {
<span class="pc bpc" id="L769" title="1 of 2 branches missed.">        ServerConnector connector = cmd.isSslEnabled() ? createHttpsConnector(server) : createHttpConnector(server);</span>
<span class="fc" id="L770">        connector.setHost(cmd.getHost());</span>
<span class="fc" id="L771">        connector.setPort(cmd.getPort());</span>
<span class="fc" id="L772">        return connector;</span>
    }

    /**
     * Create an insecure http connector
     *
     * @param server the Jetty HTTP Servlet Server
     * @return server connector that is the primary connector for the Jetty server over TCP/IP
     */
    private static ServerConnector createHttpConnector(Server server) {
<span class="fc" id="L782">        return new ServerConnector(server);</span>
    }

    /**
     * Create a secure https connector
     *
     * @param server the Jetty HTTP Servlet Server
     * @return ServerConnector is the primary connector for the Jetty server over TCP/IP
     * @throws IOException if there is an error
     */
    private ServerConnector createHttpsConnector(Server server) throws IOException {
<span class="nc" id="L793">        HttpConfiguration httpConfig = new HttpConfiguration();</span>
<span class="nc" id="L794">        httpConfig.setSecureScheme(&quot;https&quot;);</span>
<span class="nc" id="L795">        httpConfig.setSecurePort(cmd.getPort());</span>

<span class="nc" id="L797">        HttpConfiguration httpsConfig = new HttpConfiguration(httpConfig);</span>
<span class="nc" id="L798">        httpsConfig.addCustomizer(createSecureRequestCustomizer());</span>

<span class="nc" id="L800">        return new ServerConnector(server,</span>
<span class="nc" id="L801">                new SslConnectionFactory(getSslContextFactory(), HttpVersion.HTTP_1_1.asString()),</span>
                new HttpConnectionFactory(httpsConfig));
    }

    /**
     * SecureRequestCustomizer extracts the attribute from an SSLContext and sets them on the request according to Servlet
     * Specification Requirements. Jetty defaults for the SecureRequestCustomizer are:
     * &lt;ul&gt;
     * &lt;li&gt;isSniRequired() =&gt; false // Server Name Indication (SNI) is required
     * &lt;li&gt;isSniHostCheck() =&gt; true // SNI Host name must match when there is an SNI certificate
     * &lt;li&gt;getStsMaxAge() =&gt; -1 (no max age) // Strict-Transport-Security (STS) max age
     * &lt;li&gt;isStsIncludeSubDomains() =&gt; false // include-subdomain property is sent with any STS header
     * &lt;/ul&gt;
     *
     * @return a secure request customizer
     */
    private SecureRequestCustomizer createSecureRequestCustomizer() {
<span class="nc" id="L818">        SecureRequestCustomizer secureRequestCustomizer = new SecureRequestCustomizer();</span>
<span class="nc" id="L819">        secureRequestCustomizer.setSniHostCheck(cmd.isSniHostCheckEnabled());</span>
<span class="nc" id="L820">        return secureRequestCustomizer;</span>
    }

    /**
     * Create a {@link SslContextFactory.Server} using keystore and truststore config from HttpConnectionFactory.cfg,
     * probably flavored with '-SSL'. Note: only jks files are supported, but could be expanded
     *
     * @return SslContextFactory that is used to configure SSL parameters to be used by server connectors
     * @throws IOException if there is an error getting the context factory
     */
    private static SslContextFactory.Server getSslContextFactory() throws IOException {
<span class="nc" id="L831">        Configurator httpConnFactCfg = ConfigUtil.getConfigInfo(HTTPConnectionFactory.class);</span>
<span class="nc" id="L832">        String keystore = httpConnFactCfg.findStringEntry(&quot;javax.net.ssl.keyStore&quot;, &quot;no-keystore&quot;);</span>
<span class="nc" id="L833">        System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keystore);</span>
<span class="nc" id="L834">        String keystorePass = httpConnFactCfg.findStringEntry(&quot;javax.net.ssl.keyStorePassword&quot;, &quot;no-keypass&quot;);</span>
<span class="nc" id="L835">        System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, keystorePass);</span>
<span class="nc" id="L836">        String trustStore = httpConnFactCfg.findStringEntry(&quot;javax.net.ssl.trustStore&quot;, keystore);</span>
<span class="nc" id="L837">        System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustStore);</span>
<span class="nc" id="L838">        String trustStorePass = httpConnFactCfg.findStringEntry(&quot;javax.net.ssl.trustStorePassword&quot;, keystorePass);</span>
<span class="nc" id="L839">        System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, trustStorePass);</span>

<span class="nc" id="L841">        SslContextFactory.Server sslContextFactory = new SslContextFactory.Server();</span>
<span class="nc" id="L842">        sslContextFactory.setKeyStorePath(keystore);</span>
<span class="nc" id="L843">        sslContextFactory.setKeyStorePassword(keystorePass);</span>

        KeyStore trustStoreInstance;
<span class="nc" id="L846">        try (InputStream is = Files.newInputStream(Paths.get(trustStore))) {</span>
<span class="nc" id="L847">            trustStoreInstance = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="nc" id="L848">            trustStoreInstance.load(is, trustStorePass.toCharArray());</span>
<span class="nc" id="L849">        } catch (KeyStoreException | CertificateException | NoSuchAlgorithmException e) {</span>
<span class="nc" id="L850">            throw new IOException(&quot;There was an issue loading the truststore&quot;, e);</span>
<span class="nc" id="L851">        }</span>

<span class="nc" id="L853">        sslContextFactory.setTrustStore(trustStoreInstance);</span>
<span class="nc" id="L854">        return sslContextFactory;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>