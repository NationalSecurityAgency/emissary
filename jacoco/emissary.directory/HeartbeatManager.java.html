<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HeartbeatManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.directory</a> &gt; <span class="el_source">HeartbeatManager.java</span></div><h1>HeartbeatManager.java</h1><pre class="source lang-java linenums">package emissary.directory;

import emissary.client.EmissaryClient;
import emissary.client.EmissaryResponse;
import emissary.core.Namespace;
import emissary.core.NamespaceException;
import emissary.server.mvc.adapters.HeartbeatAdapter;

import org.apache.hc.client5.http.classic.methods.HttpPost;
import org.apache.hc.client5.http.entity.UrlEncodedFormEntity;
import org.apache.hc.core5.http.NameValuePair;
import org.apache.hc.core5.http.message.BasicNameValuePair;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Timer;
import java.util.TimerTask;
import java.util.concurrent.ConcurrentHashMap;
import javax.annotation.Nullable;

/**
 * Facility for directory instances to check up on each other by sending a heartbeat message
 */
public class HeartbeatManager {
    // Our logger
<span class="fc" id="L30">    protected static final Logger logger = LoggerFactory.getLogger(HeartbeatManager.class);</span>

    // parameter constants
    public static final String FROM_PLACE_NAME = &quot;hbf&quot;;
    public static final String TO_PLACE_NAME = &quot;hbt&quot;;
    public static final String BAD_RESPOSNE = &quot;Bad request -&gt; status: 500&quot;;


    /** The timer drives the tasks and scheduling of heartbeat pings */
<span class="fc" id="L39">    @Nullable</span>
    protected Timer timer = null;

    /** Directory this instance acts on behalf of */
    protected String thisDirectory;

    /** Default delay seconds before timer starts {@value} */
    public static final int DEFAULT_INITIAL_DELAY_SECONDS = 60;

    /**
     * Configured value before timer starts in seconds, default is {@value #DEFAULT_INITIAL_DELAY_SECONDS}
     */
<span class="fc" id="L51">    protected int initialDelaySeconds = DEFAULT_INITIAL_DELAY_SECONDS;</span>

    /** Default delay between timer runs {@value} */
    public static final int DEFAULT_INTERVAL_SECONDS = 30;

    /**
     * Configured value between timer runs in seconds, default is {@value #DEFAULT_INTERVAL_SECONDS}
     */
<span class="fc" id="L59">    protected int intervalSeconds = DEFAULT_INTERVAL_SECONDS;</span>

    /** Number of consecutive failures to trigger notice */
<span class="fc" id="L62">    protected int failThreshold = 3;</span>

    /** Number of consecutive failures to trigger permanent failure notice */
<span class="fc" id="L65">    protected int permanentFailThreshold = 20;</span>

    /** Status value for callers to use when setting initially healthy */
    public static final boolean IS_ALIVE = true;

    /** Status value for callers to use when setting initially not healthy */
    public static final boolean NO_CONTACT = false;

    /** The remote directories we are checking on and their health */
<span class="fc" id="L74">    protected Map&lt;String, Health&gt; directories = new ConcurrentHashMap&lt;&gt;(100, 0.8f, 3);</span>

    /**
     * Setup to manage heartbeats to remote directories
     *
     * @param directoryKey Key for directory I act on behalf of
     * @param initialDelaySeconds seconds to wait before initial timer task
     * @param intervalSeconds how often the timeer task kicks off
     */
    public HeartbeatManager(final String directoryKey, final int initialDelaySeconds, final int intervalSeconds) {
<span class="fc" id="L84">        this(directoryKey, null, initialDelaySeconds, intervalSeconds);</span>
<span class="fc" id="L85">    }</span>

    @Deprecated
    @SuppressWarnings(&quot;InconsistentOverloads&quot;)
    public HeartbeatManager(final String directoryKey, @Nullable final List&lt;String&gt; dirList, final int initialDelaySeconds,
            final int intervalSeconds) {
<span class="fc" id="L91">        this(directoryKey, initialDelaySeconds, intervalSeconds, dirList);</span>
<span class="fc" id="L92">    }</span>

    /**
     * Setup to manage heartbeats to remote directories
     *
     * @param directoryKey Key for directory I act on behalf of
     * @param initialDelaySeconds seconds to wait before initial timer task
     * @param intervalSeconds how often the timeer task kicks off
     * @param dirList list of directory keys for remote directories
     */
    public HeartbeatManager(final String directoryKey, final int initialDelaySeconds, final int intervalSeconds,
<span class="fc" id="L103">            @Nullable final List&lt;String&gt; dirList) {</span>
<span class="fc" id="L104">        this.initialDelaySeconds = initialDelaySeconds;</span>
<span class="fc" id="L105">        this.intervalSeconds = intervalSeconds;</span>

<span class="fc" id="L107">        logger.debug(&quot;Starting with initialDelay={}, interval={}&quot;, initialDelaySeconds, intervalSeconds);</span>

        // new daemon timer
<span class="fc" id="L110">        this.timer = new Timer(&quot;HeartbeatManager&quot;, true);</span>

        // Save directory key
<span class="fc" id="L113">        this.thisDirectory = directoryKey;</span>

        // Save each directory in dirList along with good
        // starting health value
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (dirList != null) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            for (final String key : dirList) {</span>
<span class="nc" id="L119">                addRemoteDirectory(key);</span>
<span class="nc" id="L120">            }</span>
        }

        // &quot;smooth&quot; execution every 30 seconds starting in 2 minutes
<span class="fc" id="L124">        this.timer.schedule(new HeartbeatTask(), (this.initialDelaySeconds * 1000L), (this.intervalSeconds * 1000L));</span>
<span class="fc" id="L125">    }</span>

    /**
     * Set the failure threshold
     */
    public void setFailThreshold(final int t) {
<span class="nc" id="L131">        this.failThreshold = t;</span>
<span class="nc" id="L132">        logger.debug(&quot;Set new fail threshold to {}&quot;, t);</span>
<span class="nc" id="L133">    }</span>

    /**
     * Set the second failure threshold
     */
    public void setPermanentFailThreshold(final int t) {
<span class="nc" id="L139">        this.permanentFailThreshold = t;</span>
<span class="nc" id="L140">        logger.debug(&quot;Set new permanent fail threshold to {}&quot;, t);</span>
<span class="nc" id="L141">    }</span>

    /**
     * Shutdown processing
     */
    public void shutDown() {
<span class="fc" id="L147">        this.timer.cancel();</span>
<span class="fc" id="L148">    }</span>

    /**
     * Add another directory to monitor
     *
     * @param key four-tuple for the remote directory
     */
    public void addRemoteDirectory(final String key) {
<span class="nc" id="L156">        addRemoteDirectory(key, true);</span>
<span class="nc" id="L157">    }</span>

    /**
     * Add another directory to monitor with initial status
     *
     * @param key four-tuple for the remote directory
     * @param isAlive initial status
     */
    public void addRemoteDirectory(final String key, final boolean isAlive) {
        // Skip if on same JVM
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (!KeyManipulator.isLocalTo(this.thisDirectory, key)) {</span>
<span class="fc" id="L168">            final String dkey = KeyManipulator.getDefaultDirectoryKey(key);</span>
<span class="fc" id="L169">            this.directories.put(dkey, new Health(isAlive, &quot;Initial status&quot;));</span>
<span class="fc" id="L170">            logger.debug(&quot;Added remote {} with initial status {} now monitoring {} remote directories&quot;, dkey, isAlive, this.directories.size());</span>
<span class="fc" id="L171">        } else {</span>
<span class="nc" id="L172">            logger.debug(&quot;Skipping local directory {}, is not remote&quot;, key);</span>
        }
<span class="fc" id="L174">    }</span>

    /**
     * Remove a directory from the monitor list
     *
     * @param key four-tuple for the remote directory
     */
    public void removeRemoteDirectory(final String key) {
<span class="nc" id="L182">        this.directories.remove(KeyManipulator.getDefaultDirectoryKey(key));</span>
<span class="nc" id="L183">    }</span>

    /**
     * Access to see if remote is healthy
     *
     * @param key four-tuple key for remote directory
     */
    public boolean isHealthy(final String key) {
<span class="nc" id="L191">        final String dirKey = KeyManipulator.getDefaultDirectoryKey(key);</span>
<span class="nc" id="L192">        final Health val = this.directories.get(dirKey);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (val != null) {</span>
<span class="nc" id="L194">            return val.isHealthy();</span>
        }
<span class="nc" id="L196">        return false;</span>
    }

    /**
     * Access to see if remote is alive
     *
     * @param key four-tuple key for remote directory
     */
    public boolean isAlive(final String key) {
<span class="fc" id="L205">        final String dirKey = KeyManipulator.getDefaultDirectoryKey(key);</span>
<span class="fc" id="L206">        final Health val = this.directories.get(dirKey);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (val != null) {</span>
<span class="fc" id="L208">            return val.isAlive();</span>
        }
<span class="nc" id="L210">        return false;</span>
    }

    /**
     * Externally set the status. Does not call trigger
     *
     * @param key directory to set status for
     * @param status new status
     * @param reason the exception message on bad status
     */
    void setHealthStatus(final String key, final boolean status, final String reason) {
<span class="fc" id="L221">        final String dirKey = KeyManipulator.getDefaultDirectoryKey(key);</span>
<span class="fc" id="L222">        final Health v = this.directories.get(dirKey);</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (v == null) {</span>
<span class="nc" id="L224">            logger.error(&quot;Not monitoring directory {}&quot;, dirKey);</span>
<span class="nc" id="L225">            return;</span>
        }

<span class="fc" id="L228">        logger.debug(&quot;Externally setting {} status for {} - {}&quot;, status, key, reason);</span>

<span class="fc" id="L230">        v.setStatus(status, reason);</span>
<span class="fc" id="L231">    }</span>

    /**
     * Set health status and call the trigger on transition
     *
     * @param key key for directory
     * @param status new status
     * @param reason the exception message on bad status
     */
    protected void healthReport(final String key, final boolean status, final String reason) {
<span class="fc" id="L241">        final String dirKey = KeyManipulator.getDefaultDirectoryKey(key);</span>
<span class="fc" id="L242">        final Health v = this.directories.get(dirKey);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">        if (v == null) {</span>
<span class="fc" id="L244">            logger.error(&quot;Not monitoring directory {}&quot;, dirKey);</span>
<span class="fc" id="L245">            return;</span>
        }

<span class="fc" id="L248">        final boolean wasAlive = v.isAlive();</span>
<span class="fc" id="L249">        final boolean wasHealthy = v.isHealthy();</span>

<span class="fc" id="L251">        v.addReport(status, reason);</span>

<span class="fc" id="L253">        final boolean isAlive = v.isAlive();</span>
<span class="fc" id="L254">        final boolean isHealthy = v.isHealthy();</span>

<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L257">            logger.debug(&quot;Reporting on {} status={}, wasAlive/Healthy={}/{}, isAlive/Healthy={}/{}&quot;, key, status, wasAlive, wasHealthy, isAlive,</span>
<span class="nc" id="L258">                    isHealthy);</span>
        }

<span class="pc bpc" id="L261" title="3 of 4 branches missed.">        if (wasAlive &amp;&amp; !isAlive) {</span>
            // We had a permanent failure.
<span class="nc" id="L263">            takeFailureAction(key, true);</span>
<span class="pc bpc" id="L264" title="3 of 4 branches missed.">        } else if (wasHealthy &amp;&amp; !isHealthy) {</span>
            // We had a negative transition.
<span class="nc" id="L266">            takeFailureAction(key, false);</span>
<span class="pc bpc" id="L267" title="2 of 4 branches missed.">        } else if (!wasHealthy &amp;&amp; isHealthy) {</span>
            // We had a positive transition.
<span class="nc" id="L269">            takeSuccessAction(key);</span>
        }
<span class="fc" id="L271">    }</span>

    /**
     * Notify our directory that there was a falure
     *
     * @param key string key of the directory that failed
     */
    public void takeFailureAction(final String key, final boolean permanent) {
<span class="nc" id="L279">        final String myKey = KeyManipulator.getServiceLocation(this.thisDirectory);</span>
        try {
<span class="nc" id="L281">            final IRemoteDirectory d = (IRemoteDirectory) Namespace.lookup(myKey);</span>
<span class="nc" id="L282">            final int count = d.irdFailDirectory(key, permanent);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            logger.info(&quot;Notified {} of failed directory {}{}, {} keys removed&quot;, myKey, key, (permanent ? &quot; permanently!&quot; : &quot;&quot;), count);</span>
<span class="nc" id="L284">        } catch (NamespaceException ne) {</span>
<span class="nc" id="L285">            logger.error(&quot;Tried to fail a remote directory {} but cannot look up my own directory using {}&quot;, key, myKey, ne);</span>
<span class="nc" id="L286">        }</span>
<span class="nc" id="L287">    }</span>

    /**
     * Notify our directory that a directory has been contacted. This could initiate a zone transfer or other action
     *
     * @param key string key of the directory that was contacted
     */
    void takeSuccessAction(final String key) {
<span class="nc" id="L295">        final String myKey = KeyManipulator.getServiceLocation(this.thisDirectory);</span>
        try {
<span class="nc" id="L297">            final DirectoryPlace d = (DirectoryPlace) Namespace.lookup(myKey);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (d.isStaticPeer(key)) {</span>
<span class="nc" id="L299">                logger.info(&quot;Notifying {} of re-established contact with {}&quot;, myKey, key);</span>
<span class="nc" id="L300">                d.contactedRemoteDirectory(key);</span>
            } else {
<span class="nc" id="L302">                logger.info(&quot;Ignoring contact with non-configured peer {}&quot;, key);</span>
            }
<span class="nc" id="L304">        } catch (NamespaceException ne) {</span>
<span class="nc" id="L305">            logger.error(&quot;Tried to reestablish a remote directory &quot; + key + &quot; but cannot look up my own directory using &quot; + myKey, ne);</span>
<span class="nc" id="L306">        }</span>
<span class="nc" id="L307">    }</span>


    /**
     * The Task thread, monitors all remote directories
     */
<span class="fc" id="L313">    class HeartbeatTask extends TimerTask {</span>
        @Override
        public void run() {
            try {
<span class="fc" id="L317">                logger.debug(&quot;Running timer task on {} directories&quot;, HeartbeatManager.this.directories.size());</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">                for (final String dir : HeartbeatManager.this.directories.keySet()) {</span>
<span class="fc" id="L319">                    heartbeat(dir);</span>
<span class="fc" id="L320">                }</span>
<span class="fc" id="L321">                logger.debug(&quot;Ending the HeartbeatTask run method&quot;);</span>
<span class="nc" id="L322">            } catch (RuntimeException e) {</span>
<span class="nc" id="L323">                logger.error(&quot;Unexpected problem in heartbeat timer&quot;, e);</span>
<span class="fc" id="L324">            }</span>
<span class="fc" id="L325">        }</span>
    }

    /**
     * Send a heartbeat message to the directory represented by key and take follow-on actions as appropriate Called from
     * the timer task normally, but can be called externally by the impatient
     *
     * @see emissary.directory.DirectoryPlace#heartbeatRemoteDirectory(String)
     * @param key key representing the directory to heartbeat
     * @return true if the directory referenced by key is up
     */
    public final boolean heartbeat(final String key) {
<span class="fc" id="L337">        boolean isup = false;</span>
        try {
<span class="fc" id="L339">            logger.debug(&quot;Sending heartbeat msg to {}&quot;, key);</span>
<span class="fc" id="L340">            EmissaryResponse response = getHeartbeat(this.thisDirectory, key);</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">            if (response.getStatus() == 200) {</span>
<span class="nc" id="L342">                healthReport(key, true, response.getContentString());</span>
<span class="nc" id="L343">                isup = true;</span>
            } else {
<span class="fc" id="L345">                healthReport(key, false, response.getContentString());</span>
<span class="fc" id="L346">                isup = false;</span>
            }
<span class="nc" id="L348">        } catch (RuntimeException e) {</span>
<span class="nc" id="L349">            logger.error(&quot;Cannot perform heartbeat&quot;, e);</span>
<span class="nc" id="L350">            healthReport(key, false, e.getMessage());</span>
<span class="nc" id="L351">            isup = false;</span>
<span class="fc" id="L352">        }</span>
<span class="fc" id="L353">        return isup;</span>
    }

    public static EmissaryResponse getHeartbeat(String fromPlace, String toPlace) {
<span class="fc" id="L357">        return getHeartbeat(fromPlace, toPlace, new EmissaryClient());</span>
    }

    public static EmissaryResponse getHeartbeat(String fromPlace, String toPlace, EmissaryClient client) {
<span class="fc" id="L361">        final String directoryUrl = KeyManipulator.getServiceHostUrl(toPlace);</span>
<span class="fc" id="L362">        final HttpPost method = client.createHttpPost(directoryUrl, EmissaryClient.context, &quot;/Heartbeat.action&quot;);</span>
<span class="fc" id="L363">        final String loc = KeyManipulator.getServiceLocation(toPlace);</span>

<span class="fc" id="L365">        final List&lt;NameValuePair&gt; nvps = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L366">        nvps.add(new BasicNameValuePair(HeartbeatAdapter.FROM_PLACE_NAME, fromPlace));</span>
<span class="fc" id="L367">        nvps.add(new BasicNameValuePair(HeartbeatAdapter.TO_PLACE_NAME, loc));</span>
<span class="fc" id="L368">        method.setEntity(new UrlEncodedFormEntity(nvps, StandardCharsets.UTF_8));</span>

<span class="fc" id="L370">        return client.send(method);</span>
    }


    /**
     * Holder class for the health information for a single remote directory
     */
    class Health {
        // Count consecutive failures
<span class="fc" id="L379">        private int failCounter = 0;</span>

        private String lastMessage;

        /**
         * Create a new Health object with the specified status and msg
         *
         * @param isAlive true if the initial status is no failures
         * @param msg the initial msg value
         */
<span class="fc" id="L389">        public Health(final boolean isAlive, final String msg) {</span>
<span class="fc" id="L390">            setStatus(isAlive, msg);</span>
<span class="fc" id="L391">        }</span>

        /**
         * Accumulate another heartbeat result
         *
         * @param v the most recent status
         * @param msg the most recent message
         */
        public void addReport(final boolean v, final String msg) {
<span class="fc" id="L400">            this.lastMessage = msg;</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">            if (v) {</span>
<span class="nc" id="L402">                this.failCounter = 0;</span>
            } else {
<span class="fc" id="L404">                this.failCounter++;</span>
            }
<span class="fc" id="L406">        }</span>

        /**
         * Set the status now
         *
         * @param isAlive false means permanent failure indicated
         * @param message message to asocciate with this statsu
         */
        void setStatus(final boolean isAlive, final String message) {
<span class="fc bfc" id="L415" title="All 2 branches covered.">            if (!isAlive) {</span>
<span class="fc" id="L416">                this.failCounter = HeartbeatManager.this.permanentFailThreshold;</span>
<span class="fc" id="L417">                this.lastMessage = message;</span>
            } else {
<span class="fc" id="L419">                this.failCounter = 0;</span>
<span class="fc" id="L420">                this.lastMessage = message;</span>
            }
<span class="fc" id="L422">        }</span>

        /**
         * Report our health status
         *
         * @return true if failed less than threshold times
         */
        public boolean isHealthy() {
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">            return this.failCounter &lt; HeartbeatManager.this.failThreshold;</span>
        }

        /**
         * Report our aliveness status
         *
         * @return true if failed less than permanent threshold times
         */
        public boolean isAlive() {
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">            return this.failCounter &lt; HeartbeatManager.this.permanentFailThreshold;</span>
        }

        /**
         * Access to the last saved message
         */
        public String getLastMessage() {
<span class="nc" id="L446">            return this.lastMessage;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>