<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DirectoryXmlContainer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.directory</a> &gt; <span class="el_source">DirectoryXmlContainer.java</span></div><h1>DirectoryXmlContainer.java</h1><pre class="source lang-java linenums">package emissary.directory;

import emissary.util.xml.SaferJDOMUtil;

import jakarta.annotation.Nullable;
import org.jdom2.Document;
import org.jdom2.Element;
import org.jdom2.JDOMException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;

/**
 * This class acts as a container and producer for turning a directory entry list into a full xml document
 */
public class DirectoryXmlContainer {

<span class="fc" id="L20">    private static final Logger logger = LoggerFactory.getLogger(DirectoryXmlContainer.class);</span>

    public static final String DIRECTORY = &quot;directory&quot;;
    public static final String LOC_ATTR = &quot;location&quot;;
    public static final String DATAID_ATTR = &quot;dataid&quot;;

    /**
     * Build an xml document from the contents of a directory place
     */
    public static Document buildDocument(final IDirectoryPlace dir) {
<span class="fc" id="L30">        final Element root = new Element(DIRECTORY);</span>
<span class="fc" id="L31">        root.setAttribute(LOC_ATTR, dir.getKey());</span>

        // Each directory entry
<span class="fc bfc" id="L34" title="All 2 branches covered.">        for (final String dataId : dir.getEntryKeys()) {</span>
<span class="fc" id="L35">            final DirectoryEntryList list = dir.getEntryList(dataId);</span>
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">            if (list != null) {</span>
<span class="fc" id="L37">                final Element listEl = list.getXml();</span>
<span class="fc" id="L38">                listEl.setAttribute(DATAID_ATTR, dataId);</span>
<span class="fc" id="L39">                root.addContent(listEl);</span>
            }
<span class="fc" id="L41">        }</span>

<span class="fc" id="L43">        return new Document(root);</span>
    }

    /**
     * Build an xml document from the map.
     * 
     * @param map the map of entries
     * @param loc directory location key
     */
    public static Document buildDocument(final DirectoryEntryMap map, final String loc) {
<span class="nc" id="L53">        final Element root = new Element(DIRECTORY);</span>
<span class="nc" id="L54">        root.setAttribute(LOC_ATTR, loc);</span>

        // Each directory entry
<span class="nc bnc" id="L57" title="All 2 branches missed.">        for (final Map.Entry&lt;String, DirectoryEntryList&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L58">            final String dataId = entry.getKey();</span>
<span class="nc" id="L59">            final DirectoryEntryList list = entry.getValue();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (list != null) {</span>
<span class="nc" id="L61">                final Element listEl = list.getXml();</span>
<span class="nc" id="L62">                listEl.setAttribute(DATAID_ATTR, dataId);</span>
<span class="nc" id="L63">                root.addContent(listEl);</span>
            }
<span class="nc" id="L65">        }</span>

<span class="nc" id="L67">        return new Document(root);</span>
    }

    /**
     * Build an xml document from the contents of the directory as if proxied through the place itself. Except when the
     * entries actually belong to the requester.
     * 
     * @param dir the directory that will act as a proxy
     * @param requester the directory doing the requesting
     */
    public static Document buildProxyDocument(final IRemoteDirectory dir, final String requester) {
<span class="nc" id="L78">        final String proxyKey = dir.getKey();</span>
<span class="nc" id="L79">        final Element root = new Element(DIRECTORY);</span>
<span class="nc" id="L80">        root.setAttribute(LOC_ATTR, proxyKey);</span>

<span class="nc" id="L82">        logger.debug(&quot;Building proxy view of dir contents for {}&quot;, requester);</span>

        // Each directory entry
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (final String dataId : dir.getEntryKeys()) {</span>
<span class="nc" id="L86">            final DirectoryEntryList list = dir.getEntryList(dataId);</span>
<span class="nc" id="L87">            logger.debug(&quot;List of {} for {} has {} entries&quot;, dataId, requester, list.size());</span>
            // set up proxy for each entry
<span class="nc bnc" id="L89" title="All 2 branches missed.">            for (final DirectoryEntry e : list) {</span>
<span class="nc" id="L90">                e.proxyFor(proxyKey);</span>
<span class="nc" id="L91">            }</span>

            // Add them to the xml
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (!list.isEmpty()) {</span>
<span class="nc" id="L95">                final Element listEl = list.getXml();</span>
<span class="nc" id="L96">                listEl.setAttribute(DATAID_ATTR, dataId);</span>
<span class="nc" id="L97">                root.addContent(listEl);</span>
            }
<span class="nc" id="L99">        }</span>
<span class="nc" id="L100">        return new Document(root);</span>
    }

    /**
     * Build an xml string from the contents of a directory place This method pulls the main entryMap of the directory.
     * 
     * @param dir the directory to pull the entryMap contents from
     * @return xml string representing the keys
     */
    public static String toXmlString(final IDirectoryPlace dir) {
<span class="fc" id="L110">        final Document jdom = buildDocument(dir);</span>
<span class="fc" id="L111">        return SaferJDOMUtil.toString(jdom);</span>
    }

    /**
     * Build an xml string from the contents of a directory place making it appear that the place represented by proxyKey
     * acts as a proxy for all or the keys in the directory map
     * 
     * @param dir the directory to pull the entryMap contents from
     * @param proxyKey place to appear as the proxy
     * @param requester the key of the remote directory that is requesting the local directory contents
     * @return xml string representing the proxied keys
     */
    public static String toXmlString(final IDirectoryPlace dir, @Nullable final String proxyKey, final String requester) {
<span class="nc" id="L124">        logger.debug(&quot;Building xml string for {}&quot;, requester);</span>
        final String xml;
<span class="nc bnc" id="L126" title="All 4 branches missed.">        if ((proxyKey == null) || !(dir instanceof IRemoteDirectory)) {</span>
<span class="nc" id="L127">            xml = toXmlString(dir);</span>
        } else {
<span class="nc" id="L129">            final Document jdom = buildProxyDocument((IRemoteDirectory) dir, requester);</span>
<span class="nc" id="L130">            xml = SaferJDOMUtil.toString(jdom);</span>
        }
<span class="nc" id="L132">        return xml;</span>
    }

    /**
     * Build a DirectoryEntryList map from string xml
     */
    public static DirectoryEntryMap buildEntryListMap(final String xml) throws JDOMException {
<span class="nc" id="L139">        final Document jdom = SaferJDOMUtil.createDocument(xml);</span>
<span class="nc" id="L140">        return buildEntryListMap(jdom);</span>
    }

    /**
     * Build a DirectoryEntryList map from a JDOM document
     */
    public static DirectoryEntryMap buildEntryListMap(final Document jdom) {
<span class="nc" id="L147">        final Element el = jdom.getRootElement();</span>
<span class="nc" id="L148">        return buildEntryListMap(el);</span>
    }

    /**
     * Build a DirectoryEntryMap from a JDOM Element
     */
    public static DirectoryEntryMap buildEntryListMap(final Element el) {
<span class="nc" id="L155">        final DirectoryEntryMap map = new DirectoryEntryMap();</span>
<span class="nc" id="L156">        final List&lt;Element&gt; entryLists = el.getChildren(DirectoryEntryList.ENTRYLIST);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (final Element listElement : entryLists) {</span>
<span class="nc" id="L158">            final DirectoryEntryList d = DirectoryEntryList.fromXml(listElement);</span>
<span class="nc" id="L159">            final String dataId = listElement.getAttributeValue(DATAID_ATTR);</span>
<span class="nc" id="L160">            map.put(dataId, d);</span>
<span class="nc" id="L161">        }</span>
<span class="nc" id="L162">        logger.debug(&quot;Constructed map of {} directory entry lists from xml&quot;, map.size());</span>

<span class="nc" id="L164">        return map;</span>
    }

    /** This class is not meant to be instantiated. */
    private DirectoryXmlContainer() {}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>