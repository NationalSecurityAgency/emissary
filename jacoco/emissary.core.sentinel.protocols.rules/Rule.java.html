<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Rule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.core.sentinel.protocols.rules</a> &gt; <span class="el_source">Rule.java</span></div><h1>Rule.java</h1><pre class="source lang-java linenums">package emissary.core.sentinel.protocols.rules;

import emissary.core.NamespaceException;
import emissary.core.sentinel.protocols.Protocol;
import emissary.pool.AgentPool;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.Collection;
import java.util.List;
import java.util.StringJoiner;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

public abstract class Rule {

<span class="fc" id="L20">    protected static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    // the name of the rule
    protected final String name;

    // the place name to test the condition
    protected final Pattern place;

    // how long to wait before alerting on stuck agents
    protected final long timeLimit;

    // percentage of mobile agents that are stuck on the same place before sounding the alarm
    protected final double threshold;

<span class="fc" id="L34">    public Rule(String name, String place, long timeLimit, double threshold) {</span>
<span class="fc" id="L35">        logger.trace(&quot;Creating rule for name={}, place={}, timeLimit={}, threshold={}&quot;, name, place, timeLimit, threshold);</span>
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">        if (StringUtils.isBlank(name)) {</span>
<span class="nc" id="L37">            throw new IllegalArgumentException(&quot;Invalid name [&quot; + name + &quot;]&quot;);</span>
        }
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">        if (StringUtils.isBlank(place)) {</span>
<span class="nc" id="L40">            throw new IllegalArgumentException(&quot;Invalid place pattern [&quot; + place + &quot;]&quot;);</span>
        }
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        if (timeLimit &lt;= 0) {</span>
<span class="nc" id="L43">            throw new IllegalArgumentException(&quot;Invalid timeLimit [&quot; + timeLimit + &quot;], must be greater than 0&quot;);</span>
        }
<span class="pc bpc" id="L45" title="2 of 4 branches missed.">        if (threshold &lt;= 0.0 || threshold &gt; 1.0) {</span>
<span class="nc" id="L46">            throw new IllegalArgumentException(&quot;Invalid threshold [&quot; + threshold + &quot;], expected a value &gt; 0.0 or &lt;= 1.0&quot;);</span>
        }
<span class="fc" id="L48">        this.name = name;</span>
<span class="fc" id="L49">        this.place = Pattern.compile(place);</span>
<span class="fc" id="L50">        this.timeLimit = timeLimit;</span>
<span class="fc" id="L51">        this.threshold = threshold;</span>
<span class="fc" id="L52">    }</span>

    public Rule(String name, String place, String timeLimit, String threshold) {
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        this(name, place, StringUtils.isBlank(timeLimit) ? 60L : Long.parseLong(timeLimit),</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">                StringUtils.isBlank(threshold) ? 1.0 : Double.parseDouble(threshold));</span>
<span class="fc" id="L57">    }</span>

    /**
     * Check the rule conditions
     *
     * @param placeAgentStats collection of the stats of a place that is currently processing
     * @return true if conditions are met, false otherwise
     */
    public boolean condition(Collection&lt;Protocol.PlaceAgentStats&gt; placeAgentStats) {
<span class="fc" id="L66">        List&lt;Protocol.PlaceAgentStats&gt; filtered =</span>
<span class="fc" id="L67">                placeAgentStats.stream().filter(p -&gt; place.matcher(p.getPlace()).matches()).collect(Collectors.toList());</span>
<span class="fc bfc" id="L68" title="All 4 branches covered.">        return overThreshold(filtered) &amp;&amp; overTimeLimit(filtered);</span>
    }

    /**
     * Check to see if the number of places in mobile agents are over the configured threshold
     *
     * @param placeAgentStats the stats of a place that is currently processing
     * @return true if the number of mobile agents stuck on the place is over the threshold, false otherwise
     */
    protected boolean overThreshold(Collection&lt;Protocol.PlaceAgentStats&gt; placeAgentStats) {
<span class="fc" id="L78">        int count = placeAgentStats.stream().mapToInt(Protocol.PlaceAgentStats::getCount).sum();</span>
<span class="fc" id="L79">        int poolSize = getAgentCount();</span>
<span class="fc" id="L80">        logger.debug(&quot;Testing threshold for place={}, counter={}, poolSize={}, threshold={}&quot;, place, count, poolSize, threshold);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        return (double) count / poolSize &gt;= this.threshold;</span>
    }

    /**
     * Get the total number of agents, idle and active. Override this method to
     * 
     * @return the total number of agents
     */
    protected int getAgentCount() {
        try {
<span class="fc" id="L91">            return AgentPool.lookup().getCurrentPoolSize();</span>
<span class="nc" id="L92">        } catch (NamespaceException ne) {</span>
<span class="nc" id="L93">            throw new IllegalStateException(ne);</span>
        }
    }

    /**
     * Check to see if the places in mobile agents are over the configured time limit
     *
     * @param placeAgentStats the stats of a place that is currently processing
     * @return true if the places in mobile agents are over the configured time limit, false otherwise
     */
    protected abstract boolean overTimeLimit(Collection&lt;Protocol.PlaceAgentStats&gt; placeAgentStats);

    @Override
    public String toString() {
<span class="fc" id="L107">        return new StringJoiner(&quot;, &quot;, &quot;{&quot;, &quot;}&quot;)</span>
<span class="fc" id="L108">                .add(&quot;\&quot;name\&quot;:\&quot;&quot; + name + &quot;\&quot;&quot;)</span>
<span class="fc" id="L109">                .add(&quot;\&quot;rule\&quot;:\&quot;&quot; + getClass().getSimpleName() + &quot;\&quot;&quot;)</span>
<span class="fc" id="L110">                .add(&quot;\&quot;place\&quot;:\&quot;&quot; + place + &quot;\&quot;&quot;)</span>
<span class="fc" id="L111">                .add(&quot;\&quot;timeLimitInMinutes\&quot;:&quot; + timeLimit)</span>
<span class="fc" id="L112">                .add(&quot;\&quot;threshold\&quot;:&quot; + threshold)</span>
<span class="fc" id="L113">                .toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>