<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SizeUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.util</a> &gt; <span class="el_source">SizeUtil.java</span></div><h1>SizeUtil.java</h1><pre class="source lang-java linenums">package emissary.util;

import emissary.core.IBaseDataObject;

import jakarta.annotation.Nullable;

import java.util.Collection;
import java.util.List;
import java.util.Map;

/**
 * This class provides routines for approximating the RAM size of Emissary objects - primarily the
 * {@link IBaseDataObject}.
 */
public class SizeUtil {

    /**
     * A flag to indicate whether we are running 32 or 64 bit JVM. Note that this is the JVM bits and not the OS bits
     */
    private static final boolean arch64;

    /**
     * A reference/pointer size in a non-compressed Ops JVM. Default is 32-bit = 4 bytes
     */
    private static final long refSize;

    /**
     * Object overhead
     */
    private static final long OBJ_OVERHEAD = 8L;

    static {
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (System.getProperty(&quot;os.arch&quot;).contains(&quot;64&quot;)) {</span>
<span class="nc" id="L34">            arch64 = true;</span>
<span class="nc" id="L35">            refSize = 8L;</span>
        } else {
<span class="nc" id="L37">            arch64 = false;</span>
<span class="nc" id="L38">            refSize = 4L;</span>
        }
<span class="nc" id="L40">    }</span>

    /**
     * &lt;i&gt;Approximate&lt;/i&gt; the amount of RAM consumed by a String.
     * &lt;p&gt;
     * See
     * &lt;a href=&quot;https://www.cs.virginia.edu/kim/publicity/pldi09tutorials/memory-efficient-java-tutorial.pdf&quot;&gt;tutorial&lt;/a&gt;
     * Slide 26.
     * &lt;p&gt;
     * This calculation is affected by the JVM architecture and whether
     * &lt;a href=&quot;https://wikis.oracle.com/display/HotSpotInternals/CompressedOops&quot;&gt;CompressedOops&lt;/a&gt; are enabled.
     *
     * @param str - the String to approximate
     * @return The approximate size, in bytes, in RAM for str
     */
    public static long sizeof(@Nullable String str) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (str == null) {</span>
<span class="nc" id="L57">            return 0L;</span>
        }
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (arch64) {</span>
<span class="nc" id="L60">            return (str.length() * 2L) + 52; // 2 bytes per UTF-16, 52 for JVM overhead &amp; bookkeeping, 64-bit arch</span>
        } else {
<span class="nc" id="L62">            return (str.length() * 2L) + 48; // 2 bytes per UTF-16, 48 for JVM overhead &amp; bookkeeping, 32-bit arch</span>
        }
    }

    /**
     * Approximate the amount of RAM consumed by an individual {@link IBaseDataObject}. The purpose of this method is to
     * approximate the RAM that will be consumed by a corresponding serialized/deserialized object, hence not all aspects of
     * the {@link IBaseDataObject} are considered. Additionally, this method does not include all the &quot;outputtable&quot; logic
     * that may be present in output filter, which could make the actual size smaller than is reported by this method.
     * 
     * @param ibdo The IBaseDataObject to approximate the size of
     * @return The approximate size, in bytes, in RAM for the IBaseDataObject
     */
    public static long sizeof(@Nullable IBaseDataObject ibdo) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (ibdo == null) {</span>
<span class="nc" id="L77">            return 0L;</span>
        }

<span class="nc" id="L80">        long totalSize = 0L;</span>

        // Primary view (potentially gigantic)
<span class="nc" id="L83">        totalSize += getPayloadMemorySize(ibdo);</span>

        // Factor in the extracted records
<span class="nc" id="L86">        totalSize += getExtractedRecordMemorySize(ibdo);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (ibdo.getParameters() == null) {</span>
<span class="nc" id="L89">            return totalSize;</span>
        } // This should never be null, but still check

        // Finally, estimate the size of the metadata parameters, assuming the underlying Strings are UTF-16
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (Map.Entry&lt;String, Collection&lt;Object&gt;&gt; entry : ibdo.getParameters().entrySet()) {</span>

            // Note: The core multimap in Emissary has CharSequence as keys. This is to allow for more
            // flexibility in key design. Under the hood, they are still Strings so the following
            // routines are safe for the time-being, but will need to be changed if the keys change

            // Get the size of the key
<span class="nc" id="L100">            String k = entry.getKey();</span>
<span class="nc" id="L101">            totalSize += sizeof(k);</span>
<span class="nc" id="L102">            totalSize += refSize;</span>

            // Similar to the above, the values in Emissary are generic Objects although almost all of them
            // are Strings. That is why the following check is made in the for loop.

            // Get the size of the List of values
<span class="nc" id="L108">            Collection&lt;Object&gt; values = entry.getValue();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            for (Object v : values) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (v instanceof String) {</span>
<span class="nc" id="L111">                    totalSize += sizeof((String) v);</span>
<span class="nc" id="L112">                    totalSize += refSize;</span>
                }
                // TODO: factor in non-String objects
                // but this is not that important since there
                // are not many of them and will change the overall
                // size minimally at this time
<span class="nc" id="L118">            }</span>
<span class="nc" id="L119">        }</span>

<span class="nc" id="L121">        return totalSize;</span>
    }

    /**
     * Estimate the size, in bytes, of the RAM of an entire {@link IBaseDataObject} family tree. This is simply the sum of
     * the sizes of the individual members of the family tree.
     *
     * @param familyTree - {@code List&lt;IBaseDataObject&gt;} representing the family tree for a document object
     * @return - the approximate size, in bytes, in RAM for the familyTree
     */
    public static long sizeof(@Nullable List&lt;IBaseDataObject&gt; familyTree) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (familyTree == null) {</span>
<span class="nc" id="L133">            return 0L;</span>
        }

<span class="nc" id="L136">        long totalSize = 0L;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        for (IBaseDataObject ibdo : familyTree) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (ibdo != null) {</span>
<span class="nc" id="L139">                totalSize += sizeof(ibdo);</span>
<span class="nc" id="L140">                totalSize += OBJ_OVERHEAD + refSize; // For the pointer to ibdo in familyTree (Object overhead)</span>
            }
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">        return totalSize;</span>
    }

    /**
     * Approximates the amount of memory consumed by the &quot;extracted records&quot; in a single IBaseDataObject. This is typically
     * the case when the framework gets eventing datasets. These extracted records are usually treated specially and not run
     * through the processing pipelines proper, but on output do appear as proper child IBaseDataObjects. In the case of a
     * large dataset, these extracted records can consume huge amounts of RAM.
     * 
     * @param ibdo - The IBaseDataObject to approximate
     * @return - The approximate memory footprint, in bytes, for extracted records of an IBaseDataObject
     */
    public static long getExtractedRecordMemorySize(@Nullable IBaseDataObject ibdo) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (ibdo == null) {</span>
<span class="nc" id="L157">            return 0L;</span>
        }

<span class="nc" id="L160">        long totalSize = 0L;</span>

        // Count up the size of any extracted children
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (ibdo.hasExtractedRecords()) {</span>
<span class="nc" id="L164">            List&lt;IBaseDataObject&gt; childObjList = ibdo.getExtractedRecords();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (childObjList != null) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                for (IBaseDataObject child : childObjList) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (child != null) {</span>
<span class="nc" id="L168">                        totalSize += sizeof(child);</span>
<span class="nc" id="L169">                        totalSize += OBJ_OVERHEAD + refSize; // For the pointer to child in childObjList (Object</span>
                                                             // overhead)
                    }
<span class="nc" id="L172">                }</span>
            }
        }

<span class="nc" id="L176">        return totalSize;</span>
    }

    /**
     * Approximate the amount of memory consumed by the various &quot;payloads&quot; of an IBaseDataObject. In this case, a payload
     * refers to the header, footer, data (primary view), and all the alternate views.
     * 
     * @param ibdo - The IBaseDataObject to approximate
     * @return - The approximate memory footprint, in bytes, for the IBaseDataObject
     */
    public static long getPayloadMemorySize(@Nullable IBaseDataObject ibdo) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (ibdo == null) {</span>
<span class="nc" id="L188">            return 0L;</span>
        }

<span class="nc" id="L191">        long totalSize = 0L;</span>

        // We don't concern ourselves with object references here, because they are likely
        // tiny compared to the various &quot;payloads&quot; and altViews. A more accurate
        // version of this method would factor those in, but they are likely to be
        // negligible

        // Primary view (potentially gigantic)
<span class="nc" id="L199">        totalSize += ibdo.dataLength(); // This always returns an int</span>

        // Header and footer size (probably not big)
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (ibdo.footer() != null) {</span>
<span class="nc" id="L203">            totalSize += ibdo.footer().length;</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (ibdo.header() != null) {</span>
<span class="nc" id="L206">            totalSize += ibdo.header().length;</span>
        }

        // Size up the alternative views
<span class="nc bnc" id="L210" title="All 2 branches missed.">        for (Map.Entry&lt;String, byte[]&gt; altView : ibdo.getAlternateViews().entrySet()) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (altView.getValue() != null) {</span>
<span class="nc" id="L212">                totalSize += altView.getValue().length;</span>
            }
<span class="nc" id="L214">        }</span>

<span class="nc" id="L216">        return totalSize;</span>
    }

    /** This class is not meant to be instantiated. */
    private SizeUtil() {}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>