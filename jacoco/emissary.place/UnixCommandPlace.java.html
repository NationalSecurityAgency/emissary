<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UnixCommandPlace.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.place</a> &gt; <span class="el_source">UnixCommandPlace.java</span></div><h1>UnixCommandPlace.java</h1><pre class="source lang-java linenums">package emissary.place;

import emissary.core.Form;
import emissary.core.IBaseDataObject;
import emissary.core.ResourceException;
import emissary.directory.KeyManipulator;
import emissary.util.shell.Executrix;
import emissary.util.shell.TempFileNames;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.util.Arrays;
import javax.annotation.Nullable;

import static emissary.core.constants.Configurations.NEW_FORM;

/**
 * Run a command external to the Emissary JVM to process data
 */
public class UnixCommandPlace extends ServiceProviderPlace {
    protected boolean doSynchronized;
    @Nullable
    protected String newForm;
    protected String newFormOnError;
<span class="pc" id="L27">    @Nullable</span>
    protected String metaDataTag = null;
<span class="pc" id="L29">    @Nullable</span>
    protected String alternateView = null;
<span class="pc" id="L31">    protected boolean addAsMetaData = false;</span>
<span class="pc" id="L32">    protected boolean perlChop = false;</span>
<span class="pc" id="L33">    protected boolean nukeAllProxies = false;</span>
<span class="pc" id="L34">    protected boolean keepFilesDebug = false;</span>
<span class="pc" id="L35">    protected String charset = &quot;8859_1&quot;;</span>
    protected String logfilename;

    protected Executrix executrix;

    /**
     * Create the place from the specified config file or resource
     * 
     * @param configInfo the config file or resource to use
     */
    public UnixCommandPlace(String configInfo) throws IOException {
<span class="nc" id="L46">        super(configInfo, &quot;UnixCommandPlace.foo.bar.com:8001&quot;);</span>
<span class="nc" id="L47">        configurePlace();</span>
<span class="nc" id="L48">    }</span>

    /**
     * Create the place from the specified config file or resource
     * 
     * @param configInfo the config file or resource to use
     * @param dir the name of the controlling directory to register with
     * @param placeLoc string name of this place
     */
    public UnixCommandPlace(String configInfo, String dir, String placeLoc) throws IOException {
<span class="nc" id="L58">        super(configInfo, dir, placeLoc);</span>
<span class="nc" id="L59">        configurePlace();</span>
<span class="nc" id="L60">    }</span>

    /**
     * Create the place from the specified config stream data
     * 
     * @param configInfo the config file or resource to use
     * @param dir the name of the controlling directory to register with
     * @param placeLoc string name of this place
     */
    public UnixCommandPlace(InputStream configInfo, String dir, String placeLoc) throws IOException {
<span class="nc" id="L70">        super(configInfo, dir, placeLoc);</span>
<span class="nc" id="L71">        configurePlace();</span>
<span class="nc" id="L72">    }</span>

    /**
     * Create the place from the specified config stream data
     * 
     * @param configInfo the config file or resource to use
     */
    public UnixCommandPlace(InputStream configInfo) throws IOException {
<span class="fc" id="L80">        super(configInfo);</span>
<span class="fc" id="L81">        configurePlace();</span>
<span class="fc" id="L82">    }</span>

    /**
     * Configure the instance
     * &lt;ul&gt;
     * &lt;li&gt;SYNCHRONIZED_PROCESS: true if you want to synchronize in java, default is false&lt;/li&gt;
     * &lt;li&gt;NEW_FORM: new current form on success, default UNKNOWN&lt;/li&gt;
     * &lt;li&gt;NEW_FORM_ON_ERROR: new current form on error, default ERROR&lt;/li&gt;
     * &lt;li&gt;ADD_AS_ALTERNATE_VIEW: add output as an alt view using name provided as view name&lt;/li&gt;
     * &lt;li&gt;ADD_AS_META_DATA: add output as metadata value using name provided as key&lt;/li&gt;
     * &lt;li&gt;PERL_CHOP: if true chomp data returned, default false&lt;/li&gt;
     * &lt;li&gt;NUKE_ALL_PROXIES: if true remove all of this places proxies from current form stack when done, default false&lt;/li&gt;
     * &lt;li&gt;OUTPUT_CHARSET: charset of the process output, default 8859_1&lt;/li&gt;
     * &lt;li&gt;KEEP_FILES_DEBUG: when true don't clean up after exec is finished, default false&lt;/li&gt;
     * &lt;li&gt;LOG_FILE_NAME: name of output file to translate into logger commands, default: [servicename].log from key&lt;/li&gt;
     * &lt;/ul&gt;
     * Also all of the config values read by emissary.util.shell.Executrix are needed here
     */
    protected void configurePlace() {
<span class="fc" id="L101">        doSynchronized = configG.findBooleanEntry(&quot;SYNCHRONIZED_PROCESS&quot;, false);</span>
<span class="fc" id="L102">        newForm = configG.findStringEntry(NEW_FORM, Form.UNKNOWN);</span>
<span class="pc bpc" id="L103" title="3 of 4 branches missed.">        if (newForm == null &amp;&amp; keys.get(0).indexOf(&quot;.ID.&quot;) &gt; -1) {</span>
<span class="nc" id="L104">            newForm = Form.UNKNOWN;</span>
        }
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (&quot;&lt;null&gt;&quot;.equals(newForm)) {</span>
<span class="nc" id="L107">            newForm = null;</span>
        }
<span class="fc" id="L109">        newFormOnError = configG.findStringEntry(&quot;NEW_FORM_ON_ERROR&quot;, Form.ERROR);</span>
<span class="fc" id="L110">        alternateView = configG.findStringEntry(&quot;ADD_AS_ALTERNATE_VIEW&quot;, null);</span>
<span class="fc" id="L111">        metaDataTag = configG.findStringEntry(&quot;ADD_AS_META_DATA&quot;, null);</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (metaDataTag != null) {</span>
<span class="nc" id="L113">            addAsMetaData = true;</span>
        }
<span class="fc" id="L115">        perlChop = configG.findBooleanEntry(&quot;PERL_CHOP&quot;, false);</span>
<span class="fc" id="L116">        nukeAllProxies = configG.findBooleanEntry(&quot;NUKE_ALL_PROXIES&quot;, false);</span>
<span class="fc" id="L117">        keepFilesDebug = configG.findBooleanEntry(&quot;KEEP_FILES_DEBUG&quot;, false);</span>
<span class="fc" id="L118">        charset = configG.findStringEntry(&quot;OUTPUT_CHARSET&quot;, charset);</span>
<span class="fc" id="L119">        executrix = new Executrix(configG);</span>
<span class="fc" id="L120">        logfilename = configG.findStringEntry(&quot;LOG_FILE_NAME&quot;, KeyManipulator.getServiceName(keys.get(0)) + &quot;.log&quot;);</span>
<span class="fc" id="L121">        logger.debug(&quot;Configured {} type process with charset {}&quot;, executrix.getOutput(), charset);</span>
<span class="fc" id="L122">    }</span>

    /**
     * Set a custom executrix, allows easier mocking among other things
     * 
     * @param e the new executrix instance to use
     */
    public void setExecutrix(Executrix e) {
<span class="fc" id="L130">        executrix = e;</span>
<span class="fc" id="L131">    }</span>

    /**
     * Set the output type programatically
     */
    public void setStdOutputCommand() {
<span class="nc" id="L137">        executrix.setOutputStd();</span>
<span class="nc" id="L138">        logger.debug(&quot;Output type set to STD&quot;);</span>
<span class="nc" id="L139">    }</span>

    /**
     * Set the output type programatically
     */
    public void setFileOutputCommand() {
<span class="fc" id="L145">        executrix.setOutputFile();</span>
<span class="fc" id="L146">        logger.debug(&quot;Output type set to FILE&quot;);</span>
<span class="fc" id="L147">    }</span>

    /**
     * get the log file name
     */
    public String getLogFileName() {
<span class="nc" id="L153">        return logfilename;</span>
    }

    /**
     * Log the messages found in the log file
     * 
     * @param tempDir the directory where the command executed
     */
    protected void logMessages(String tempDir) {
        // if there is a log file, read it and log the messages
        try {
<span class="fc" id="L164">            String lfn = tempDir + &quot;/&quot; + logfilename;</span>
<span class="fc" id="L165">            byte[] logdata = Executrix.readDataFromFile(lfn, true);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            if (logdata != null) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">                for (String message : new String(logdata, charset).split(&quot;\n&quot;)) {</span>
<span class="fc" id="L168">                    logger.info(message);</span>
                }
            }
<span class="nc" id="L171">        } catch (Exception ignore) {</span>
<span class="nc" id="L172">            logger.debug(&quot;Error logging messages&quot;, ignore);</span>
<span class="fc" id="L173">        }</span>
<span class="fc" id="L174">    }</span>

    /**
     * Run the file process
     */
    @Nullable
    @SuppressWarnings(&quot;AvoidObjectArrays&quot;)
    public byte[] fileProcess(String[] cmd, String outputFile) {
<span class="fc" id="L182">        logger.debug(&quot;fileProcess({})&quot;, Arrays.asList(cmd));</span>
<span class="fc" id="L183">        StringBuilder errbuf = new StringBuilder();</span>
<span class="fc" id="L184">        int result = executrix.execute(cmd, (StringBuilder) null, errbuf);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (result != 0) {</span>
<span class="fc" id="L186">            logger.warn(&quot;exec error in fileProcess: {} produced STDERR {}&quot;, Arrays.asList(cmd), errbuf.toString());</span>
<span class="fc" id="L187">            return null;</span>
        }
<span class="fc" id="L189">        return Executrix.readDataFromFile(outputFile);</span>
    }

    /**
     * Run the stdout process
     * 
     * @param cmd command with arguments
     * @param chop if true chomp CRLF from output
     * @return bytes of output from command execution
     */
    @Nullable
    @SuppressWarnings(&quot;AvoidObjectArrays&quot;)
    public byte[] stdOutProcess(String[] cmd, boolean chop) {
<span class="fc" id="L202">        logger.debug(&quot;stdOutProcess({},{}) with charset {}&quot;, Arrays.asList(cmd), chop, charset);</span>
<span class="fc" id="L203">        StringBuilder outbuf = new StringBuilder();</span>
<span class="fc" id="L204">        StringBuilder errbuf = new StringBuilder();</span>
<span class="fc" id="L205">        int result = executrix.execute(cmd, outbuf, errbuf, charset);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">        if (result != 0) {</span>
<span class="fc" id="L207">            logger.warn(&quot;exec error in stdOutProcess: {} produced STDERR {}&quot;, Arrays.asList(cmd), errbuf.toString());</span>
<span class="fc" id="L208">            return null;</span>
        }
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (chop) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            while (outbuf.length() &gt; 0) {</span>
<span class="nc" id="L212">                char c = outbuf.charAt(outbuf.length() - 1);</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">                if (c == '\n' || c == '\r') {</span>
<span class="nc" id="L214">                    outbuf.setLength(outbuf.length() - 1);</span>
                } else {
                    break;
                }
<span class="nc" id="L218">            }</span>
        }

        try {
<span class="fc" id="L222">            return outbuf.toString().getBytes(charset);</span>
<span class="nc" id="L223">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L224">            logger.error(&quot;UnixCommandPlace.stdOutProcess charset problem&quot;, e);</span>
<span class="nc" id="L225">            return outbuf.toString().getBytes();</span>
        }
    }

    /**
     * Validate that we should process this data
     */
    protected boolean validDataHook(@Nullable IBaseDataObject d) {
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        return d != null;</span>
    }


    /**
     * Process the data coming from MobileAgent
     * 
     * @param theDataObject payload to process
     */
    @Override
    public void process(IBaseDataObject theDataObject) throws ResourceException {
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        if (validDataHook(theDataObject)) {</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">            if (doSynchronized) {</span>
<span class="nc" id="L246">                synchronizedProcess(theDataObject);</span>
            } else {
<span class="fc" id="L248">                unSynchronizedProcess(theDataObject);</span>
            }
        }
<span class="fc" id="L251">    }</span>


    /**
     * Process the data in a synchronized wrapper
     * 
     * @param theDataObject payload to process
     */
    protected synchronized void synchronizedProcess(IBaseDataObject theDataObject) throws ResourceException {
<span class="nc" id="L260">        processData(theDataObject);</span>
<span class="nc" id="L261">    }</span>


    /**
     * Process the data in an un-synchronized wrapper
     * 
     * @param theDataObject payload to process
     */
    protected void unSynchronizedProcess(IBaseDataObject theDataObject) throws ResourceException {
<span class="fc" id="L270">        processData(theDataObject);</span>
<span class="fc" id="L271">    }</span>


    /**
     * Helper routine to run command on data
     * 
     * @param data the bytes to run the command on
     * @return byte array of output
     */
    @SuppressWarnings(&quot;CatchingUnchecked&quot;)
    protected byte[] runCommandOn(byte[] data) throws ResourceException {
<span class="fc" id="L282">        TempFileNames names = executrix.createTempFilenames();</span>
<span class="fc" id="L283">        String tempDirName = names.getTempDir();</span>
<span class="fc" id="L284">        String inputFileName = names.getInputFilename();</span>
<span class="fc" id="L285">        String outputFileName = names.getOutputFilename();</span>
<span class="fc" id="L286">        File tempDir = new File(tempDirName);</span>
<span class="fc" id="L287">        byte[] outputData = null;</span>

        try {
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">            if (!tempDir.mkdirs()) {</span>
<span class="nc" id="L291">                logger.warn(&quot;Could not create temp directory for process {}&quot;, tempDirName);</span>
<span class="nc" id="L292">                return outputData;</span>
            }

<span class="fc" id="L295">            boolean written = Executrix.writeDataToFile(data, inputFileName, true);</span>

<span class="pc bpc" id="L297" title="1 of 2 branches missed.">            if (written) {</span>
<span class="fc" id="L298">                String[] cmd = executrix.getCommand(names);</span>

<span class="fc bfc" id="L300" title="All 2 branches covered.">                if (executrix.getOutput().equals(&quot;FILE&quot;)) {</span>
<span class="fc" id="L301">                    outputData = fileProcess(cmd, outputFileName);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                } else if (executrix.getOutput().equals(&quot;STD&quot;)) {</span>
<span class="fc" id="L303">                    outputData = stdOutProcess(cmd, perlChop);</span>
                } else {
<span class="nc" id="L305">                    logger.error(&quot;No output type specified&quot;);</span>
                }

<span class="fc" id="L308">                logMessages(tempDirName);</span>
            }

<span class="nc" id="L311">        } catch (Exception ex) {</span>
<span class="nc" id="L312">            logger.warn(&quot;Bad execution of commands&quot;, ex);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (ex instanceof InterruptedException) {</span>
<span class="nc" id="L314">                throw new ResourceException(ex); // framework notification to stop</span>
            }
        } finally {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            if (!keepFilesDebug) {</span>
                // delete all files here!!!
<span class="fc" id="L319">                Executrix.cleanupDirectory(tempDir);</span>
            }
        }

<span class="fc" id="L323">        return outputData;</span>

    }

    /**
     * Hook to add command ouput as an alternate view
     * 
     * @param tData the data object we ran the command on
     * @param newForm the name of the alternate view or null
     * @param outputData the result of running the command
     */
    protected void asAlternateViewHook(IBaseDataObject tData, String newForm, byte[] outputData) {
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        tData.addAlternateView(newForm != null ? newForm : tData.currentForm(), outputData);</span>
<span class="fc" id="L336">    }</span>

    /**
     * Hook to add command output as metadata
     * 
     * @param tData the data object we ran the command on
     * @param tag the configured name of the new metadata item
     * @param outputData the result of running the command
     */
    protected void asMetaDataHook(IBaseDataObject tData, String tag, byte[] outputData) {
<span class="nc" id="L346">        tData.putParameter(metaDataTag, new String(outputData));</span>
<span class="nc bnc" id="L347" title="All 4 branches missed.">        if (keys.get(0).indexOf(&quot;.TRANSFORM.&quot;) == -1 &amp;&amp; newForm != null) {</span>
<span class="nc" id="L348">            tData.setCurrentForm(newForm);</span>
        }
<span class="nc" id="L350">    }</span>

    /**
     * Hook to set command output as the current form
     * 
     * @param tData the data object the command was run on
     * @param outputData the results of running the command
     */
    protected void asCurrentFormHook(IBaseDataObject tData, byte[] outputData) {
<span class="nc" id="L359">        tData.setCurrentForm(new String(outputData));</span>
<span class="nc" id="L360">    }</span>

    /**
     * Hook to add command output as the data element
     * 
     * @param tData the data object the command was run on
     * @param outputData the results of running the command
     */
    protected void asDataHook(IBaseDataObject tData, byte[] outputData) {
<span class="nc" id="L369">        tData.setData(outputData);</span>
<span class="nc" id="L370">    }</span>

    /**
     * Hook to handle error or null output from command
     * 
     * @param tData the data object the command was run on
     */
    protected void errorHook(IBaseDataObject tData) {
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">        if (newFormOnError != null) {</span>
<span class="fc" id="L379">            tData.setCurrentForm(newFormOnError);</span>
        }
<span class="fc" id="L381">        tData.addProcessingError(&quot;&quot; + keys.get(0) + &quot;: command produced null or no output&quot;);</span>
<span class="fc" id="L382">    }</span>

    /**
     * Hook for services not coded in this implementation
     * 
     * @param serviceType the configured service type
     * @param tData data object the command was run on
     * @param outputData results of the command that was run
     */
    protected void serviceHook(String serviceType, IBaseDataObject tData, byte[] outputData) {
<span class="nc" id="L392">        logger.warn(&quot;Unknown service type: {}&quot;, serviceType);</span>
<span class="nc" id="L393">    }</span>


    /**
     * Run the command and process the results
     * 
     * @param tData the data object to process
     */
    protected void processData(IBaseDataObject tData) throws ResourceException {

<span class="fc" id="L403">        byte[] outputData = runCommandOn(findPreferredData(tData));</span>
<span class="fc" id="L404">        String serviceType = KeyManipulator.getServiceType(keys.get(0));</span>

<span class="pc bpc" id="L406" title="2 of 4 branches missed.">        if (serviceType.equals(&quot;ID&quot;) || serviceType.equals(&quot;ANALYZE&quot;)) {</span>
<span class="pc bpc" id="L407" title="1 of 4 branches missed.">            if (outputData == null || outputData.length == 0) {</span>
<span class="fc" id="L408">                errorHook(tData);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">            } else if (addAsMetaData) {</span>
<span class="nc" id="L410">                asMetaDataHook(tData, metaDataTag, outputData);</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">            } else if (alternateView != null) {</span>
<span class="fc" id="L412">                asAlternateViewHook(tData, alternateView, outputData);</span>
            } else {
<span class="nc" id="L414">                asCurrentFormHook(tData, outputData);</span>
            }
<span class="nc bnc" id="L416" title="All 2 branches missed.">        } else if (serviceType.equals(&quot;TRANSFORM&quot;)) {</span>
<span class="nc bnc" id="L417" title="All 4 branches missed.">            if (outputData == null || outputData.length == 0) {</span>
<span class="nc" id="L418">                errorHook(tData);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">            } else if (alternateView != null) {</span>
<span class="nc" id="L420">                asAlternateViewHook(tData, alternateView, outputData);</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            } else if (addAsMetaData) {</span>
<span class="nc" id="L422">                asMetaDataHook(tData, metaDataTag, outputData);</span>
            } else {
<span class="nc" id="L424">                asDataHook(tData, outputData);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">                if (nukeAllProxies) {</span>
<span class="nc" id="L426">                    nukeMyProxies(tData);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                    if (newForm != null) {</span>
<span class="nc" id="L428">                        tData.pushCurrentForm(newForm);</span>
                    }
<span class="nc bnc" id="L430" title="All 2 branches missed.">                } else if (newForm != null) {</span>
<span class="nc" id="L431">                    tData.setCurrentForm(newForm);</span>
                }
            }
        } else {
<span class="nc" id="L435">            serviceHook(serviceType, tData, outputData);</span>
        }

<span class="fc" id="L438">    }</span>

    /**
     * Get data to process
     *
     * @param tData the data object
     * @return the data to process
     */
    protected byte[] findPreferredData(IBaseDataObject tData) {
<span class="fc" id="L447">        return tData.data();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>