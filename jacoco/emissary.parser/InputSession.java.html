<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InputSession.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.parser</a> &gt; <span class="el_source">InputSession.java</span></div><h1>InputSession.java</h1><pre class="source lang-java linenums">package emissary.parser;

import jakarta.annotation.Nullable;
import org.apache.commons.collections4.CollectionUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Detailed session information as it is parsed This class just records offsets and length of various things using lists
 * of PositionRecord. If you want to actually produce the bytes of a session see SessionParser.decomposeSession and
 * emissary.parser.DecomposedSession
 * &lt;p&gt;
 * No assertions are made about the order of the header, footer, and data sections within the original byte array, it
 * can be constructed from position records in any order, possibly overlapping and repeated, We only assert that the
 * sections asked for are not out of bounds with respect to the overall array boundaries.
 * &lt;p&gt;
 * The validation scheme allows the overall bounds to be set at either the beginning or at the end of session parsing
 * without performance penalty either way.
 */
public class InputSession {

    // Logger
<span class="fc" id="L28">    private static final Logger logger = LoggerFactory.getLogger(InputSession.class);</span>

    // Overall start/length of the session
<span class="fc" id="L31">    @Nullable</span>
    protected PositionRecord overall = null;

    // ordered list of PositionRecord for the header within the session
<span class="fc" id="L35">    protected List&lt;PositionRecord&gt; header = new ArrayList&lt;&gt;();</span>

    // ordered list of PositionRecord for the footer within the session
<span class="fc" id="L38">    protected List&lt;PositionRecord&gt; footer = new ArrayList&lt;&gt;();</span>

    // ordered list of PositionRecord for the data within the session
<span class="fc" id="L41">    protected List&lt;PositionRecord&gt; data = new ArrayList&lt;&gt;();</span>

    // unordered collected metadata during parsing
<span class="fc" id="L44">    protected Map&lt;String, Object&gt; metaData = new HashMap&lt;&gt;();</span>

    // Indicator of validness
<span class="fc" id="L47">    protected boolean valid = true;</span>

    /**
     * Record details of an input session
     */
<span class="fc" id="L52">    public InputSession() {}</span>

    /**
     * Record details of an input session
     * 
     * @param o the overall position record
     */
<span class="fc" id="L59">    public InputSession(PositionRecord o) {</span>
<span class="fc" id="L60">        this.overall = o;</span>
<span class="fc" id="L61">    }</span>

    /**
     * Record details of an input session
     * 
     * @param o the overall position record
     * @param d position records for the data
     */
    public InputSession(PositionRecord o, List&lt;PositionRecord&gt; d) throws ParserException {
<span class="fc" id="L70">        this(o);</span>
<span class="fc" id="L71">        addDataRecs(d);</span>
<span class="fc" id="L72">    }</span>

    /**
     * Record details of an input session
     * 
     * @param o the overall position record
     * @param d position record for the data
     */
    public InputSession(PositionRecord o, PositionRecord d) throws ParserException {
<span class="fc" id="L81">        this(o);</span>
<span class="fc" id="L82">        addDataRec(d);</span>
<span class="fc" id="L83">    }</span>

    /**
     * Record details of an input session
     * 
     * @param o the overall position record
     * @param h position records for the header
     * @param f position records for the footer
     * @param d position records for the data
     */
    public InputSession(PositionRecord o, List&lt;PositionRecord&gt; h, List&lt;PositionRecord&gt; f, List&lt;PositionRecord&gt; d) throws ParserException {
<span class="fc" id="L94">        this(o, d);</span>
<span class="fc" id="L95">        addHeaderRecs(h);</span>
<span class="fc" id="L96">        addFooterRecs(f);</span>
<span class="fc" id="L97">    }</span>

    /**
     * Record details of an input session
     * 
     * @param o the overall position record
     * @param h position record for the header
     * @param f position record for the footer
     * @param d position record for the data
     * @param m map of collected metadata
     */
    public InputSession(PositionRecord o, List&lt;PositionRecord&gt; h, List&lt;PositionRecord&gt; f, List&lt;PositionRecord&gt; d, Map&lt;String, Object&gt; m)
            throws ParserException {
<span class="nc" id="L110">        this(o, h, f, d);</span>
<span class="nc" id="L111">        addMetaData(m);</span>
<span class="nc" id="L112">    }</span>

    /**
     * Set the overall position record
     * 
     * @param rec the PositionRecord for the overall session range
     */
    public void setOverall(PositionRecord rec) throws ParserException {
<span class="fc" id="L120">        this.overall = rec;</span>
<span class="nc" id="L121">        validateAll();</span>
<span class="nc" id="L122">    }</span>

    /**
     * Set the overall position record from the data
     * 
     * @param start for the position record
     * @param length for the position record
     */
    public void setOverall(int start, int length) throws ParserException {
<span class="nc" id="L131">        setOverall(new PositionRecord(start, length));</span>
<span class="nc" id="L132">    }</span>

    /**
     * Add a map of metadata
     * 
     * @param m map of String key and String or PositionRecord values
     */
    public void addMetaData(Map&lt;String, Object&gt; m) throws ParserException {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; entry : m.entrySet()) {</span>
<span class="nc" id="L141">            String key = entry.getKey();</span>
<span class="nc" id="L142">            Object val = entry.getValue();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (val instanceof PositionRecord) {</span>
<span class="nc" id="L144">                validateRecord((PositionRecord) val);</span>
<span class="nc" id="L145">                metaData.put(key, val);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            } else if (val instanceof String) {</span>
<span class="nc" id="L147">                metaData.put(key, val);</span>
            } else {
<span class="nc" id="L149">                logger.warn(&quot;Ignoring metadata record named {} with type of {} - it is not a PositionRecord or a String&quot;, key,</span>
<span class="nc" id="L150">                        val.getClass().getName());</span>
            }
<span class="nc" id="L152">        }</span>
<span class="nc" id="L153">    }</span>

    /**
     * Set the session validity
     * 
     * @param b true if session is valid
     */
    public void setValid(boolean b) {
<span class="fc" id="L161">        this.valid = b;</span>
<span class="fc" id="L162">    }</span>

    /**
     * Get session validity
     * 
     * @return true if session is valid
     */
    public boolean isValid() {
<span class="nc" id="L170">        return valid;</span>
    }

    /**
     * Get overall start position
     * 
     * @return overall start
     */
    public long getStart() {
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (overall != null) {</span>
<span class="fc" id="L180">            return overall.getPosition();</span>
        }
<span class="nc" id="L182">        return 0;</span>
    }

    /**
     * Get overall length
     * 
     * @return overall length
     */
    public long getLength() {
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (overall != null) {</span>
<span class="fc" id="L192">            return overall.getLength();</span>
        }
<span class="nc" id="L194">        return 0;</span>
    }

    /**
     * Get overall position record for the session
     * 
     * @return overall position record
     */
    public PositionRecord getOverall() {
<span class="nc" id="L203">        return overall;</span>
    }

    /**
     * Add and validate a list of header records
     * 
     * @param h list of PositionRecord
     * @throws ParserException when a record is out of bounds
     */
    public void addHeaderRecs(@Nullable List&lt;PositionRecord&gt; h) throws ParserException {
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (CollectionUtils.isNotEmpty(h)) {</span>
<span class="fc" id="L214">            validateList(h);</span>
<span class="fc" id="L215">            header.addAll(h);</span>
        }
<span class="fc" id="L217">    }</span>

    /**
     * Add and validate a list of data records
     * 
     * @param d list of PositionRecord
     * @throws ParserException when a record is out of bounds
     */
    public void addDataRecs(@Nullable List&lt;PositionRecord&gt; d) throws ParserException {
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        if (CollectionUtils.isNotEmpty(d)) {</span>
<span class="fc" id="L227">            validateList(d);</span>
<span class="fc" id="L228">            data.addAll(d);</span>
        }
<span class="fc" id="L230">    }</span>

    /**
     * Add and validate a list of footer records
     * 
     * @param f list of PositionRecord
     * @throws ParserException when a record is out of bounds
     */
    public void addFooterRecs(@Nullable List&lt;PositionRecord&gt; f) throws ParserException {
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">        if (CollectionUtils.isNotEmpty(f)) {</span>
<span class="fc" id="L240">            validateList(f);</span>
<span class="fc" id="L241">            footer.addAll(f);</span>
        }
<span class="fc" id="L243">    }</span>

    /**
     * Add and validate a header record
     * 
     * @param r the record to add
     * @throws ParserException when a record is out of bounds
     */
    public void addHeaderRec(PositionRecord r) throws ParserException {
<span class="fc" id="L252">        validateRecord(r);</span>
<span class="fc" id="L253">        header.add(r);</span>
<span class="fc" id="L254">    }</span>

    /**
     * Create a position record and add it to the header
     * 
     * @param pos starting position
     * @param len length of data
     * @throws ParserException when out of bounds
     */
    public void addHeaderRec(int pos, int len) throws ParserException {
<span class="nc" id="L264">        addHeaderRec(new PositionRecord(pos, len));</span>
<span class="nc" id="L265">    }</span>

    /**
     * Add and validate a footer record
     * 
     * @param r the record to add
     * @throws ParserException when a record is out of bounds
     */
    public void addFooterRec(PositionRecord r) throws ParserException {
<span class="nc" id="L274">        validateRecord(r);</span>
<span class="nc" id="L275">        footer.add(r);</span>
<span class="nc" id="L276">    }</span>

    /**
     * Create a position record and add it to the footer
     * 
     * @param pos starting position
     * @param len length of data
     * @throws ParserException when out of bounds
     */
    public void addFooterRec(int pos, int len) throws ParserException {
<span class="nc" id="L286">        addFooterRec(new PositionRecord(pos, len));</span>
<span class="nc" id="L287">    }</span>

    /**
     * Add a validate a data record
     * 
     * @param r the record to add
     * @throws ParserException when a record is out of bounds
     */
    public void addDataRec(PositionRecord r) throws ParserException {
<span class="fc" id="L296">        validateRecord(r);</span>
<span class="fc" id="L297">        data.add(r);</span>
<span class="fc" id="L298">    }</span>

    /**
     * Create a position record and add it to the data
     * 
     * @param pos starting position
     * @param len length of data
     * @throws ParserException when out of bounds
     */
    public void addDataRec(int pos, int len) throws ParserException {
<span class="nc" id="L308">        addDataRec(new PositionRecord(pos, len));</span>
<span class="nc" id="L309">    }</span>

    /**
     * Add a metadata position record
     * 
     * @param name name of metadata item
     * @param r position record of data
     * @throws ParserException when out of bounds
     */
    public void addMetaDataRec(String name, PositionRecord r) throws ParserException {
<span class="nc" id="L319">        validateRecord(r);</span>
<span class="nc" id="L320">        metaData.put(name, r);</span>
<span class="nc" id="L321">    }</span>

    /**
     * Add a metadata position record
     * 
     * @param name name of metadata item
     * @param rec string value of metadata item
     */
    public void addMetaDataRec(String name, String rec) {
<span class="nc" id="L330">        metaData.put(name, rec);</span>
<span class="nc" id="L331">    }</span>

    /**
     * Count of data position records
     * 
     * @return count
     */
    public int getDataCount() {
<span class="fc" id="L339">        return data.size();</span>
    }

    /**
     * Count of footer position records
     * 
     * @return count
     */
    public int getFooterCount() {
<span class="fc" id="L348">        return footer.size();</span>
    }

    /**
     * Count of header position records
     * 
     * @return count
     */
    public int getHeaderCount() {
<span class="fc" id="L357">        return header.size();</span>
    }

    /**
     * Count of metadata records
     * 
     * @return count
     */
    public int getMetaDataCount() {
<span class="nc" id="L366">        return metaData.size();</span>
    }

    /**
     * Get footer position records
     * 
     * @return list of PositionRecord
     */
    public List&lt;PositionRecord&gt; getFooter() {
<span class="fc" id="L375">        return footer;</span>
    }

    /**
     * List header records
     * 
     * @return list of PositionRecord
     */
    public List&lt;PositionRecord&gt; getHeader() {
<span class="fc" id="L384">        return header;</span>
    }

    /**
     * Get data position records
     * 
     * @return list of PositionRecord
     */
    public List&lt;PositionRecord&gt; getData() {
<span class="fc" id="L393">        return data;</span>
    }

    /**
     * Return a map of metadata information. Some values will be Strings, others will be PositionRecords
     * 
     * @return metadata
     */
    public Map&lt;String, Object&gt; getMetaData() {
<span class="fc" id="L402">        return metaData;</span>
    }

    /**
     * Info pump for debugging output
     * 
     * @return string representation
     */
    @Override
    public String toString() {
<span class="nc" id="L412">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        sb.append(&quot;Session is &quot;).append(this.isValid() ? &quot;&quot; : &quot;not&quot;).append(&quot;valid&quot;).append(&quot;\n&quot;);</span>
<span class="nc" id="L414">        sb.append(&quot;Session overall &quot;).append(this.getOverall()).append(&quot;\n&quot;);</span>
<span class="nc" id="L415">        sb.append(&quot;Header record &quot;).append(this.getHeader()).append(&quot;\n&quot;);</span>
<span class="nc" id="L416">        sb.append(&quot;Data record &quot;).append(this.getData()).append(&quot;\n&quot;);</span>
<span class="nc" id="L417">        sb.append(&quot;Footer record &quot;).append(this.getFooter()).append(&quot;\n&quot;);</span>
<span class="nc" id="L418">        Map&lt;String, Object&gt; m = this.getMetaData();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        sb.append(&quot;Metadata count &quot;).append(m == null ? 0 : m.size()).append(&quot;\n&quot;);</span>
<span class="nc" id="L420">        return sb.toString();</span>
    }

    /**
     * Validation of one PositionRecord. Does nothing if overall bounds not yet set
     * 
     * @param r the record to check
     * @throws ParserException when out of bounds
     */
    protected void validateRecord(PositionRecord r) throws ParserException {
<span class="pc bpc" id="L430" title="2 of 8 branches missed.">        if (overall != null &amp;&amp; r != null &amp;&amp; ((r.getPosition() &lt; overall.getPosition()) || (r.getEnd() &gt; overall.getEnd()))) {</span>
<span class="fc" id="L431">            throw new ParserException(&quot;Position record &quot; + r + &quot; is out of bounds for the data &quot; + overall);</span>
        }
<span class="fc" id="L433">    }</span>

    /**
     * Validate a list of PositionRecord. Does nothing if overall bounds not yet set
     * 
     * @param list the list of PositionRecord
     * @throws ParserException when out of bounds
     */
    protected void validateList(@Nullable List&lt;PositionRecord&gt; list) throws ParserException {

<span class="pc bpc" id="L443" title="2 of 4 branches missed.">        if (overall == null || list == null) {</span>
<span class="nc" id="L444">            return;</span>
        }

<span class="fc bfc" id="L447" title="All 2 branches covered.">        for (PositionRecord p : list) {</span>
<span class="fc" id="L448">            validateRecord(p);</span>
<span class="fc" id="L449">        }</span>
<span class="fc" id="L450">    }</span>

    /**
     * Validate everything. Does nothing if overall bounds not yet set
     * 
     * @throws ParserException when out of bounds
     */
    protected void validateAll() throws ParserException {
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (overall == null) {</span>
<span class="nc" id="L459">            return;</span>
        }
<span class="nc" id="L461">        validateList(header);</span>
<span class="nc" id="L462">        validateList(footer);</span>
<span class="nc" id="L463">        validateList(data);</span>
<span class="nc" id="L464">        validateMetaData();</span>
<span class="nc" id="L465">    }</span>

    /**
     * Validate the PositionRecords in the metadata map Does nothing if overall bounds not yet set
     * 
     * @throws ParserException when out of bounds
     */
    protected void validateMetaData() throws ParserException {
<span class="nc bnc" id="L473" title="All 4 branches missed.">        if (overall == null || metaData.isEmpty()) {</span>
<span class="nc" id="L474">            return;</span>
        }

<span class="nc bnc" id="L477" title="All 2 branches missed.">        for (Object obj : metaData.values()) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (obj instanceof PositionRecord) {</span>
<span class="nc" id="L479">                validateRecord((PositionRecord) obj);</span>
            }
<span class="nc" id="L481">        }</span>
<span class="nc" id="L482">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>