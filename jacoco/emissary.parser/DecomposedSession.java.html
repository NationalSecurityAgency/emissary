<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DecomposedSession.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.parser</a> &gt; <span class="el_source">DecomposedSession.java</span></div><h1>DecomposedSession.java</h1><pre class="source lang-java linenums">package emissary.parser;

import emissary.core.IBaseDataObject;

import com.google.common.collect.ArrayListMultimap;
import com.google.common.collect.Multimap;
import jakarta.annotation.Nullable;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;

/**
 * Representation of a fully built session with metadata, header, footer, classification, initial forms, and data
 */
<span class="fc" id="L17">public class DecomposedSession {</span>

    // Serializable
    static final long serialVersionUID = 8714610712515636160L;

    // Keys for the decomposed session map
    static final String HEADER_KEY = &quot;HEADER&quot;;
    static final String FOOTER_KEY = &quot;FOOTER&quot;;
    static final String DATA_KEY = &quot;DATA&quot;;
    static final String CLASSIFICATION_KEY = &quot;CLASSIFICATION&quot;;
    static final String METADATA_KEY = &quot;METADATA&quot;;
    static final String INITIAL_FORMS = &quot;INITIAL_FORMS&quot;;

<span class="fc" id="L30">    @Nullable</span>
    protected byte[] header = null;
<span class="fc" id="L32">    @Nullable</span>
    protected byte[] footer = null;
<span class="fc" id="L34">    @Nullable</span>
    protected byte[] data = null;
<span class="fc" id="L36">    @Nullable</span>
    protected String classification = null;
<span class="fc" id="L38">    protected List&lt;String&gt; initialForms = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L39">    protected ArrayListMultimap&lt;String, Object&gt; metadata = ArrayListMultimap.create(100, 1);</span>

    /**
     * Set the header. This implementation does NOT make a copy of the byte array Previously existing header data is lost
     *
     * @param h byte array of header data to set
     */
    public void setHeader(byte[] h) {
<span class="fc" id="L47">        header = h;</span>
<span class="fc" id="L48">    }</span>

    /**
     * Get the header
     *
     * @return byte array of header data or null if none
     */
    public byte[] getHeader() {
<span class="fc" id="L56">        return header;</span>
    }

    /**
     * Set the footer This implementation does NOT make a copy of the byte array Previously existing footer data is lost
     *
     * @param f byte array of data to set as footer
     */
    public void setFooter(byte[] f) {
<span class="fc" id="L65">        footer = f;</span>
<span class="fc" id="L66">    }</span>

    /**
     * Get the footer
     *
     * @return byte array of footer or null if none
     */
    public byte[] getFooter() {
<span class="fc" id="L74">        return footer;</span>
    }

    /**
     * Set the data entry using the passed in byte array This implementation does NOT make a copy of the byte array
     * Previously existing data is lost
     *
     * @param d bytes to set
     */
    public void setData(byte[] d) {
<span class="fc" id="L84">        setData(d, false);</span>
<span class="fc" id="L85">    }</span>

    /**
     * Set the data entry using the passed in byte array or a copy Previously existing data is lost
     *
     * @param d bytes to set
     * @param copy make a copy when true
     */
    public void setData(@Nullable byte[] d, boolean copy) {
<span class="fc bfc" id="L94" title="All 4 branches covered.">        if (d == null || !copy) {</span>
<span class="fc" id="L95">            data = d;</span>
        } else {
<span class="fc" id="L97">            setData(d, 0, d.length);</span>
        }
<span class="fc" id="L99">    }</span>

    /**
     * Set the data from the specified portion of the array Always makes a copy. Previously existing data is lost.
     *
     * @param d bytes to set
     * @param start start offset
     * @param end ending offset
     */
    public void setData(byte[] d, int start, int end) {
<span class="fc" id="L109">        data = new byte[end - start];</span>
<span class="fc" id="L110">        System.arraycopy(d, start, data, 0, data.length);</span>
<span class="fc" id="L111">    }</span>

    /**
     * Get the data entry
     *
     * @return the data bytes or null if none
     */
    public byte[] getData() {
<span class="fc" id="L119">        return data;</span>
    }

    /**
     * Set the classification
     *
     * @param s the value to set
     */
    public void setClassification(String s) {
<span class="fc" id="L128">        classification = s;</span>
<span class="fc" id="L129">    }</span>

    /**
     * Get the classification
     *
     * @return the classification entry or null if none
     */
    public String getClassification() {
<span class="fc" id="L137">        return classification;</span>
    }

    /**
     * Add metadata from map, any existing is lost
     *
     * @param m the map of metadata to set
     */
    public void setMetaData(Map&lt;String, ?&gt; m) {
<span class="fc" id="L146">        metadata.clear();</span>
<span class="fc" id="L147">        addMetaData(m);</span>
<span class="fc" id="L148">    }</span>

    /**
     * Return the metadata map, creating one if it doesnt exist already
     *
     * @return the map of MetaData
     */
    public Map&lt;String, Collection&lt;Object&gt;&gt; getMetaData() {
<span class="fc" id="L156">        return metadata.asMap();</span>
    }

    /**
     * Return the entire multimap of metadata for use during the construction process
     */
    public Multimap&lt;String, Object&gt; getMultimap() {
<span class="fc" id="L163">        return metadata;</span>
    }

    /**
     * Test for header presence
     *
     * @return true if there is a header entry
     */
    public boolean hasHeader() {
<span class="fc bfc" id="L172" title="All 2 branches covered.">        return header != null;</span>
    }

    /**
     * Test for footer presence
     *
     * @return true if there is a footer entry
     */
    public boolean hasFooter() {
<span class="fc bfc" id="L181" title="All 2 branches covered.">        return footer != null;</span>
    }

    /**
     * Test for classification presence
     *
     * @return true if there is a classification entry
     */
    public boolean hasClassification() {
<span class="fc bfc" id="L190" title="All 2 branches covered.">        return classification != null;</span>
    }

    /**
     * Test for metadata presence
     *
     * @return true if there is a metadata entry
     */
    public boolean hasMetaData() {
<span class="fc bfc" id="L199" title="All 2 branches covered.">        return metadata.size() &gt; 0;</span>
    }

    /**
     * Test for data presence
     *
     * @return true if there is a data entry
     */
    public boolean hasData() {
<span class="fc bfc" id="L208" title="All 2 branches covered.">        return data != null;</span>
    }

    /**
     * Add a record to the nested MetaData map Metadata map will be created if not existing
     *
     * @param name the name of the meta record to add
     * @param value the value to add
     */
    public void addMetaData(@Nullable String name, @Nullable Object value) {
<span class="fc bfc" id="L218" title="All 4 branches covered.">        if (name != null &amp;&amp; value != null) {</span>
<span class="fc" id="L219">            metadata.put(name, value);</span>
        }
<span class="fc" id="L221">    }</span>

    /**
     * Add a map of metadata to the existing map MetaData map will be created if not existing
     *
     * @param m map of items to add
     */
    public void addMetaData(@Nullable Map&lt;String, ?&gt; m) {
<span class="pc bpc" id="L229" title="1 of 4 branches missed.">        if (m != null &amp;&amp; m.size() &gt; 0) {</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">            for (Map.Entry&lt;String, ?&gt; entry : m.entrySet()) {</span>
<span class="fc" id="L231">                String key = entry.getKey();</span>
<span class="fc" id="L232">                Object v = entry.getValue();</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">                if (v instanceof Iterable) {</span>
<span class="fc" id="L234">                    metadata.putAll(key, (Iterable&lt;?&gt;) v);</span>
                } else {
<span class="nc" id="L236">                    metadata.put(key, v);</span>
                }
<span class="fc" id="L238">            }</span>
        }
<span class="fc" id="L240">    }</span>

    /**
     * Return a single metadata item
     *
     * @param key the name
     */
    public List&lt;Object&gt; getMetaDataItem(String key) {
<span class="fc" id="L248">        return metadata.get(key);</span>
    }

    /**
     * Get a simplified form of a single metadata item using semi-colon as the separator
     *
     * @param key the name
     */
    public String getStringMetadataItem(String key) {
<span class="fc" id="L257">        return getStringMetadataItem(key, IBaseDataObject.DEFAULT_PARAM_SEPARATOR);</span>
    }

    /**
     * Get a simplified form of a single metadata item
     *
     * @param key the name
     * @param sep the separator
     */
    @Nullable
    public String getStringMetadataItem(String key, String sep) {
<span class="fc" id="L268">        List&lt;Object&gt; o = metadata.get(key);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">        if (o.isEmpty()) {</span>
<span class="fc" id="L270">            return null;</span>
        }
<span class="fc" id="L272">        StringBuilder sb = new StringBuilder();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (Object item : o) {</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">            if (sb.length() &gt; 0) {</span>
<span class="fc" id="L275">                sb.append(sep);</span>
            }
<span class="fc" id="L277">            sb.append(item);</span>
<span class="fc" id="L278">        }</span>
<span class="fc" id="L279">        return sb.toString();</span>
    }

    /**
     * Add an initial form to the list of existing forms. Initial forms will be created if not existing
     *
     * @param form initial form to add
     */
    public void addInitialForm(@Nullable String form) {
<span class="fc bfc" id="L288" title="All 2 branches covered.">        if (form != null) {</span>
<span class="fc" id="L289">            initialForms.add(form);</span>
        }
<span class="fc" id="L291">    }</span>

    /**
     * Set the list of initial forms to use This will overwrite existing initial forms
     */
    public void setInitialForms(@Nullable List&lt;String&gt; forms) {
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (forms != null) {</span>
<span class="fc" id="L298">            initialForms = new ArrayList&lt;&gt;(forms);</span>
        }
<span class="fc" id="L300">    }</span>

    /**
     * Get the list of initial forms. Returns empty list if no initial forms have been set
     */
    public List&lt;String&gt; getInitialForms() {
<span class="fc" id="L306">        return initialForms;</span>
    }

    /**
     * Check validity of session
     */
    public boolean isValid() {
<span class="fc bfc" id="L313" title="All 6 branches covered.">        return hasData() || hasHeader() || hasFooter();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>