<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileDataServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.pickup.file</a> &gt; <span class="el_source">FileDataServer.java</span></div><h1>FileDataServer.java</h1><pre class="source lang-java linenums">package emissary.pickup.file;

import emissary.core.Pausable;
import emissary.log.MDCConstants;

import jakarta.annotation.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

import java.io.File;
import java.io.FilenameFilter;

/**
 * Thread to monitor a directory for files
 */
public class FileDataServer extends Pausable {

    // Logger
<span class="fc" id="L20">    protected static final Logger logger = LoggerFactory.getLogger(FileDataServer.class);</span>

    // Directory we will monitor
    protected String theDataDir;
    protected File theDirectory;

    // Ref to my owner
<span class="fc" id="L27">    @Nullable</span>
    protected FilePickUpPlace myParent = null;

    // protected int filesInList;

    // Thread safe termination
<span class="fc" id="L33">    protected boolean timeToShutdown = false;</span>

    // How often to check in millis
<span class="fc" id="L36">    protected long pollingInterval = 1000;</span>

    // How many files to group together
<span class="fc" id="L39">    protected int bundleSize = 20;</span>

    /**
     * Create the directory monitor
     * 
     * @param inputDataDirectory directory path to monitor
     * @param parent the FPP that created me
     * @param pollingInterval how often to check for new files in millis
     */
    @SuppressWarnings(&quot;ThreadPriorityCheck&quot;)
    public FileDataServer(String inputDataDirectory, FilePickUpPlace parent, long pollingInterval) {

        // Name the thread
<span class="fc" id="L52">        super(&quot;FileInput-&quot; + inputDataDirectory);</span>

<span class="fc" id="L54">        myParent = parent;</span>
<span class="fc" id="L55">        this.pollingInterval = pollingInterval;</span>
<span class="fc" id="L56">        theDataDir = inputDataDirectory;</span>
<span class="fc" id="L57">        theDirectory = new File(inputDataDirectory);</span>

<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (!theDirectory.isDirectory()) {</span>
<span class="fc" id="L60">            logger.warn(theDirectory.getName() + &quot; is not a directory&quot;);</span>
        }

        // Set our priority to below agent processing priority
<span class="fc" id="L64">        this.setPriority(Thread.NORM_PRIORITY - 2);</span>

<span class="fc" id="L66">        this.setDaemon(true);</span>
<span class="fc" id="L67">    }</span>

    /**
     * Set the number of files to group when polling
     * 
     * @param sz the new value for bundleSize
     */
    public void setBundleSize(int sz) {
<span class="fc" id="L75">        bundleSize = sz;</span>
<span class="fc" id="L76">    }</span>

    /**
     * Implement the run method from Thread to start monitoring Runs until the shutdown() method is called
     */
    @Override
    public void run() {

        // Loop can be terminated by calling the shutdown() method
<span class="fc bfc" id="L85" title="All 2 branches covered.">        while (!timeToShutdown) {</span>

<span class="pc bpc" id="L87" title="1 of 2 branches missed.">            if (checkPaused()) {</span>
<span class="nc" id="L88">                continue;</span>
            }

<span class="fc" id="L91">            String holdDir = myParent.getInProcessArea();</span>
<span class="fc" id="L92">            String errDir = myParent.getErrorArea();</span>

            // Process files currently in the pickup directory, list
            // the first bundleSize in a batch
<span class="fc" id="L96">            String[] fileList = theDirectory.list(new FilenameFilter() {</span>
<span class="fc" id="L97">                final int maxFileToList = bundleSize;</span>
<span class="fc" id="L98">                int filesInList = 0;</span>

                @Override
                public boolean accept(File dir, String name) {
<span class="nc bnc" id="L102" title="All 4 branches missed.">                    return !name.startsWith(&quot;.&quot;) &amp;&amp; ++filesInList &lt;= maxFileToList;</span>
                }
            });

            // Rename all the selected files out of the polling area
<span class="pc bpc" id="L107" title="3 of 4 branches missed.">            for (int i = 0; fileList != null &amp;&amp; i &lt; fileList.length; i++) {</span>
<span class="nc" id="L108">                File f = new File(theDataDir, fileList[i]);</span>

<span class="nc bnc" id="L110" title="All 6 branches missed.">                if (!f.exists() || !f.isFile() || !f.canRead()) {</span>
<span class="nc" id="L111">                    reportProblem(f, errDir);</span>
<span class="nc" id="L112">                    continue;</span>
                }

                // Move to in process area
<span class="nc" id="L116">                File newFile = new File(holdDir, fileList[i]);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (!f.renameTo(newFile)) {</span>
                    // This is normal when many FileDataServers
                    // on multiple machines are looking at the
                    // same underlying filesystem space
<span class="nc" id="L121">                    logger.warn(&quot;FileDataServer - file: &quot; + f.getPath() + &quot; Could not be renamed to: &quot; + newFile.getPath());</span>
<span class="nc" id="L122">                    fileList[i] = null;</span>
                }
            }

<span class="fc" id="L126">            int processedCount = 0;</span>

            // Process the batch of files just collected, if any
<span class="pc bpc" id="L129" title="3 of 4 branches missed.">            for (int i = 0; fileList != null &amp;&amp; i &lt; fileList.length; i++) {</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (fileList[i] == null) {</span>
<span class="nc" id="L132">                    continue;</span>
                }

                // Notify parent to process file
<span class="nc" id="L136">                File newFile = new File(holdDir, fileList[i]);</span>
                try {
<span class="nc" id="L138">                    MDC.put(MDCConstants.SHORT_NAME, fileList[i]);</span>
<span class="nc" id="L139">                    myParent.processDataFile(newFile);</span>
<span class="nc" id="L140">                    processedCount++;</span>
<span class="nc" id="L141">                } catch (Exception e) {</span>
<span class="nc" id="L142">                    logger.warn(&quot;***Cannot process {}&quot;, newFile, e);</span>
<span class="nc" id="L143">                    boolean renamed = newFile.renameTo(new File(errDir, newFile.getName()));</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    if (!renamed) {</span>
<span class="nc" id="L145">                        logger.warn(&quot;***Cannot move {} to the error directory {}&quot;, newFile, errDir);</span>
                    }
                } finally {
<span class="nc" id="L148">                    MDC.remove(MDCConstants.SHORT_NAME);</span>
                }
            }


            // Delay for the polling interval if there was
            // nothing to do for this last round, otherwise
            // get right back in there...
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (processedCount == 0) {</span>
                try {
<span class="fc" id="L158">                    Thread.sleep(pollingInterval);</span>
<span class="nc" id="L159">                } catch (InterruptedException e) {</span>
<span class="nc" id="L160">                    Thread.currentThread().interrupt();</span>
<span class="fc" id="L161">                }</span>
            }

<span class="fc" id="L164">        } // end while</span>
<span class="fc" id="L165">    }</span>

    /**
     * Report the problem file and move it to the error location
     * 
     * @param f the file having the problem
     */
    protected void reportProblem(File f, String errDir) {
<span class="nc" id="L173">        MDC.put(MDCConstants.SHORT_NAME, f.getPath());</span>
        try {
<span class="nc" id="L175">            String n = f.getName();</span>
<span class="nc" id="L176">            boolean renamed = false;</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (f.exists()) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (!f.canRead()) {</span>
<span class="nc" id="L180">                    logger.warn(&quot;FileDataServer: cannot read file&quot;);</span>
<span class="nc" id="L181">                    renamed = f.renameTo(new File(errDir, n));</span>
                }

<span class="nc bnc" id="L184" title="All 2 branches missed.">                else if (!f.isFile()) {</span>
<span class="nc" id="L185">                    logger.warn(&quot;FileDataServer: file is not a normal file&quot;);</span>
<span class="nc" id="L186">                    renamed = f.renameTo(new File(errDir, n));</span>
                }

<span class="nc bnc" id="L189" title="All 2 branches missed.">                else if (f.length() &lt;= 0) {</span>
<span class="nc" id="L190">                    logger.warn(&quot;FileDataServer: file has zero size&quot;);</span>
<span class="nc" id="L191">                    renamed = f.renameTo(new File(errDir, n));</span>
                }

<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (!renamed) {</span>
<span class="nc" id="L195">                    logger.warn(&quot;File could not be moved&quot;);</span>
                }
            } else {
<span class="nc" id="L198">                logger.warn(&quot;File does not exist&quot;);</span>
            }
        } finally {
<span class="nc" id="L201">            MDC.remove(MDCConstants.SHORT_NAME);</span>
        }
<span class="nc" id="L203">    }</span>

    /**
     * Shutdown the thread
     */
    public void shutdown() {
<span class="fc" id="L209">        timeToShutdown = true;</span>
<span class="fc" id="L210">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>